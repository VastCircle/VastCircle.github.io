<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='概述 TileLink Cached (TL-C) 协议通过为主设备提供缓存共享数据块副本的能力，完善了 TileLink 协议。这些本地缓存副本必须根据实现定义的一致性策略保持一致性。本章节定义的 TL-C 标准一致性协议规定了哪些内存访问操作可以对缓存数据的副本执行，以及哪些消息可用于传输数据块的副本。实现中叠加的一致性策略则规定了在接收到内存访问操作后，如何在特定的 TileLink 代理网络中传播副本和权限。具体一致性策略的描述超出了本文档的范围。
'><title>使用Tilelink实现缓存一致性（cache conherence）</title>
<link rel=canonical href=https://VastCircle.github.io/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/><link rel=stylesheet href=/scss/style.min.46208cabd58e8bcef0cfb7d7ea6b561adcca3b91dd1fc6657493a44f03c5db75.css><meta property='og:title' content='使用Tilelink实现缓存一致性（cache conherence）'><meta property='og:description' content='概述 TileLink Cached (TL-C) 协议通过为主设备提供缓存共享数据块副本的能力，完善了 TileLink 协议。这些本地缓存副本必须根据实现定义的一致性策略保持一致性。本章节定义的 TL-C 标准一致性协议规定了哪些内存访问操作可以对缓存数据的副本执行，以及哪些消息可用于传输数据块的副本。实现中叠加的一致性策略则规定了在接收到内存访问操作后，如何在特定的 TileLink 代理网络中传播副本和权限。具体一致性策略的描述超出了本文档的范围。
'><meta property='og:url' content='https://VastCircle.github.io/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/'><meta property='og:site_name' content="VastCircle's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='TileLink'><meta property='article:tag' content='协议'><meta property='article:published_time' content='2024-11-22T16:29:39+08:00'><meta property='article:modified_time' content='2024-11-22T16:29:39+08:00'><meta name=twitter:title content="使用Tilelink实现缓存一致性（cache conherence）"><meta name=twitter:description content="概述 TileLink Cached (TL-C) 协议通过为主设备提供缓存共享数据块副本的能力，完善了 TileLink 协议。这些本地缓存副本必须根据实现定义的一致性策略保持一致性。本章节定义的 TL-C 标准一致性协议规定了哪些内存访问操作可以对缓存数据的副本执行，以及哪些消息可用于传输数据块的副本。实现中叠加的一致性策略则规定了在接收到内存访问操作后，如何在特定的 TileLink 代理网络中传播副本和权限。具体一致性策略的描述超出了本文档的范围。
"><style>:root{--article-font-family:"Noto Serif SC", var(--base-font-family)}</style><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
<!--
extended
-->
on-phone--column extended"><div id=article-toolbar><a href=https://VastCircle.github.io/ class=back-home><svg class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span></a></div><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><a href=/><img src=/img/avatar_hu9516569771622178000.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><h1 class=site-name><a href=/>VastCircle's blog</a></h1><h2 class=site-description>To shine , not to be illuminated</h2><ol class=social-menu><li><a href=https://github.com/VastCircle target=_blank title=GitHub><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>friends</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/>缓存一致性</a></header><h2 class=article-title><a href=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/>使用Tilelink实现缓存一致性（cache conherence）</a></h2><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 22, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-words>4056字</time></div></footer></div></header><section class=article-content><h2 id=概述>概述</h2><p>TileLink Cached (TL-C) 协议通过为主设备提供缓存共享数据块副本的能力，完善了 TileLink 协议。这些本地缓存副本必须根据实现定义的一致性策略保持一致性。本章节定义的 TL-C 标准一致性协议规定了哪些内存访问操作可以对缓存数据的副本执行，以及哪些消息可用于传输数据块的副本。实现中叠加的一致性策略则规定了在接收到内存访问操作后，如何在特定的 TileLink 代理网络中传播副本和权限。具体一致性策略的描述超出了本文档的范围。</p><p>总的来说，TL-C 在 TileLink 协议规范中增加了以下内容：</p><ul><li>三种新操作</li><li>三个新通道</li><li>一种新的五步消息序列模板</li><li>十种新消息类型</li></ul><p>新增的操作是用于创建或删除数据块缓存副本的传输操作。这些传输操作不会修改数据块的值，而是转移副本的读/写权限。传输操作与之前定义的 TL-UL 和 TL-UH 内存访问操作无缝协作，且二者在顺序上是串行化的。因为每个传输操作逻辑上要么发生在内存访问操作之前，要么发生在之后，并且所有代理对这种顺序一致认可，因此在 TileLink 网络中保持了一致性不变量。</p><p>当内存访问操作通过 TileLink 网络时，中间缓存可能在其中嵌套递归传输操作。缓存通过首先使用传输操作获得数据块的足够权限，然后利用其一致的本地副本来处理内存访问操作。</p><p>地址的“可缓存性”是一个属性，TileLink 的实现必须防止创建不可缓存地址的副本（见第 6.3 节）。相反，之前在 TL-UL 和 TL-UH 中定义的内存访问操作可以被主设备用来访问可缓存地址，而无需自行缓存它们。某些主设备可能选择缓存某个数据块，而同一内存层级中的其他主设备可能选择不缓存。</p><p>下一节将概述可供设计者用于定义特定实现依赖一致性策略的基本操作、消息和权限。该规范并未强制使用某一种特定策略，而是定义了一个可供构建策略的协议基础。</p><h2 id=使用-tilelink-实现缓存一致性>使用 TileLink 实现缓存一致性</h2><p>所有基于Tilelink的一致性协议都由传输权限以读取和写入数据块的副本组成。内存访问操作需要agent获取正确的权限，然后agent才能将访问操作应用于缓存的副本。当agent想要在本地处理访问操作时，必须首先使用**传输操作(Transfer operations)**来获取必要的权限。传输操作通过网络创建或删除副本，从而修改每个副本提供的权限。</p><p>代理的块副本拥有权限，“None",&ldquo;Read&rdquo;,&ldquo;Read+Write&rdquo;。对于任何给定地址，任何给定master和拥有该地址的slave之间只有一条路径。当所有此类路径覆盖在 TileLink 网络 DAG 上时，它们会形成一棵树，其根为单个从属路径。对于每个地址，该树包含所有针对该地址的操作执行的路径。如果我们删除所有不能缓存数据的代理，我们就会留下一棵<strong>缓存代理树</strong>，描述可能缓存特定地址数据的所有位置。</p><p>在逻辑时间的任何给定时刻，这些代理的某些子集实际上包含缓存数据的副本。这些代理形成了 CoherenceTree。包容性的 TileLink 一致性协议要求<strong>树根据内存访问操作而增长和收缩</strong>。图中的每个节点都属于描述其在树上位置的四个类别之一：</p><p>Nothing: 当前不缓存数据副本的节点。既没有读权限，也没有写权限。</p><p>Trunk :具有缓存副本的节点，位于 Tip 和 Root 之间的路径上。对副本既没有读权限，也没有写权限。对于提示处发生的写入，该副本可能已过时。</p><p>Tip（with no Branches）:具有缓存副本的节点，用作内存访问序列化点。对其副本具有读/写权限，该副本可能包含脏数据。</p><p>Tip（with Branches）:具有缓存副本的节点，用作写入序列化点。对其副本具有读取和写入权限，该副本可能包含过去写入的脏数据。</p><p>Branch: 具有位于提示上方的缓存副本的节点。对其副本具有只读权限。</p><p><figure class=gallery-image style=flex-grow:149;flex-basis:357px><a href=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122165832557.png data-size=480x322><img src=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122165832557.png width=480 height=322 srcset="/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122165832557_hu5086166827793620406.png 480w, /2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122165832557_hu5752016001538414188.png 1024w" loading=lazy></a></figure></p><p>“TT”代 表 Trunk Tip，“T”代 表 Trunk，“B”代表Branch。</p><p>A：根对唯一副本具有写+读权限。</p><p>B：单个master对trunktip有写+读权限。</p><p>C：多个master对分支有读权限。</p><p>D：多个master对分支有读权限，部分分支被剪枝</p><p>一致性树按照内存、L3、L2、L1的顺序自下而上生长，内存作为根节点拥有可读可写的权限，在每一层中子节点的权限都不能超过父节点的权限。其中TT代表拥有T权限的枝杈上的叶子节点，说明该节点上层只有N或B权限，相反T权限而不是TT权限的节点代表上层一定还有T/TT权限节点。</p><h3 id=operation>operation</h3><p>three new operations are termed transfer operations (move permissions or cached copied of data through the network)</p><p><figure class=gallery-image style=flex-grow:285;flex-basis:684px><a href=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122170916836.png data-size=762x267><img src=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122170916836.png width=762 height=267 srcset="/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122170916836_hu16902930323023380423.png 480w, /2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122170916836_hu16357757267193371021.png 1024w" loading=lazy></a></figure></p><p><strong>Acquire</strong></p><p>在请求的主设备中创建数据块的新副本（或特定权限）。</p><p><strong>Release</strong></p><p>将数据块的副本（或特定权限）从请求的主设备返还给从设备。</p><p><strong>Probe</strong></p><p>强制从主设备移除数据块的副本（或特定权限），并交给请求的从设备。</p><p>获取（Acquire）操作通过延伸主干或从现有分支或末端添加新分支来扩展树结构。为了实现这一点，可能需要通过递归探测（Probe）操作修剪旧的主干或分支，才能生长新的分支。释放（Release）操作则通过自愿缩减树结构来修剪树，通常是为了响应缓存容量冲突。</p><h3 id=channels>Channels</h3><p><strong>通道 A</strong>
master发起获取读取或写入缓存数据块副本的权限。</p><p><strong>通道 B</strong>
slave查询或修改master在缓存数据块上的权限，或将内存访问请求转发给master。</p><p><strong>通道 C</strong>
master确认通道 B 消息，可能会释放数据块上的权限以及任何脏数据。也用于自愿回写脏缓存数据。</p><p><strong>通道 D</strong></p><p>slave向原始请求者提供数据或权限，授予访问缓存数据块的权限。也用于确认脏数据的自愿回写。</p><p><strong>通道 E</strong>
master提供交易完成的最终确认，用于slave进行交易序列化。</p><h3 id=tl-c-messages>TL-C Messages</h3><p>包含三个操作的十个消息</p><p><figure class=gallery-image style=flex-grow:216;flex-basis:519px><a href=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122172128627.png data-size=758x350><img src=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122172128627.png width=758 height=350 srcset="/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122172128627_hu1586931982977865012.png 480w, /2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122172128627_hu15490960147174014980.png 1024w" loading=lazy></a></figure></p><h3 id=permissions-transitons>Permissions Transitons</h3><p>传输在逻辑上对权限进行操作，因此包含它们的消息必须指定预期结果：<strong>升级到更多权限、降级到更少权限或保持权限不变的无操作</strong>。这些变化是根据它们对特定地址的一致性树的形状的影响来指定的。我们将可能的权限转换集分为六个子集；不同的子集可用作某些消息的参数，如下小节中所定义。</p><p><figure class=gallery-image style=flex-grow:335;flex-basis:804px><a href=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122172845164.png data-size=758x226><img src=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122172845164.png width=758 height=226 srcset="/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122172845164_hu11380476503169813060.png 480w, /2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122172845164_hu876807239002810646.png 1024w" loading=lazy></a></figure></p><p><strong>Prune</strong> 包括权限降级操作，缩小树结构，并记录先前的权限和新的较低权限。</p><p><strong>Grow</strong> 包括权限升级操作，扩展树结构，并记录先前的权限和新的较高权限。</p><p><strong>Report</strong> 包括不进行操作的情况，其中权限保持不变，但报告当前的权限状态。</p><p><strong>Cap</strong> 包括权限变更操作，不指定原始权限是什么，而是只说明它们应该变成什么</p><h2 id=flows-and-waves>Flows and Waves</h2><p>下图概括了3个新流程，Acquire总是触发a recursive Grant request and GrantAck response。根据块权限的状态和一致性策略，Acquire 也能触发一个或者多个Release or Probe operations.黑点的移动表明事务序列化点已受到该操作的影响。</p><p><figure class=gallery-image style=flex-grow:284;flex-basis:681px><a href=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122182809833.png data-size=861x303><img src=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122182809833.png width=861 height=303 srcset="/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122182809833_hu10573803865363368663.png 480w, /2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122182809833_hu4050188003432519117.png 1024w" loading=lazy></a></figure></p><p>下图显示了一个消息流，该消息流更详细地说明了包含所有三个新操作的事务。在此流程中，<strong>主设备通过获取在目标数据块的本地副本中读取或写入数据的许可来对存储器访问操作请求做出反应</strong>。此事务完成后，主节点已获得读取或写入缓存块以及该块数据的副本的权限。其他主机被probed，迫使他们释放对该块的权限并写回其拥有的脏数据。此外，发出 Acquire 的 master 还使用 Release 来自愿释放其对缓存块的权限。通常，<strong>当高速缓存必须逐出包含脏数据的块，以便用重新填充到高速缓存中的块替换它时</strong>，就会发生这种类型的事务。此事务完成后，<strong>主服务器将失去读取或写入第二个缓存块及其数据副本的权限</strong>。如果从属设备能够使用目录跟踪哪些主设备拥有该块的副本，则此元数据已更新以反映两个块的权限更改。l</p><p><figure class=gallery-image style=flex-grow:71;flex-basis:170px><a href=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122183427417.png data-size=530x745><img src=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122183427417.png width=530 height=745 srcset="/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122183427417_hu2483982651560567251.png 480w, /2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122183427417_hu3962498415780453785.png 1024w" loading=lazy></a></figure></p><p>把master1 看成l1,slave看成l2</p><p>1.缓存主设备向从设备发送 Acquire</p><p>2.为了为预期的响应腾出空间，同一个主设备发送 Release</p><p>3.从设备与后备存储(backing memory)通信（如果需要）</p><p>4.从设备使用 ReleaseAck 确认写回事务完成</p><p>5.从设备还向其他主设备发送必要的 Probes。</p><p>6.从设备等待接收每个发送的 Probe 的 ProbeAck</p><p>7.从设备与后备存储通信（如果需要）。</p><p>8.从设备向原始请求者发送 Grant</p><p>9.原始主设备通过 GrantAck 响应，从而完成事务。</p><p><figure class=gallery-image style=flex-grow:261;flex-basis:627px><a href=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122184700989.png data-size=876x335><img src=/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122184700989.png width=876 height=335 srcset="/2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122184700989_hu840340175533663251.png 480w, /2024/%E4%BD%BF%E7%94%A8tilelink%E5%AE%9E%E7%8E%B0%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/image-20241122184700989_hu10357549498107321375.png 1024w" loading=lazy></a></figure></p><p>TileLink 协议基于三个消息流：<strong>Acquire</strong>、<strong>Release</strong> 和 <strong>Grant</strong>（或类似的），这些流构成了所有涉及缓存块传输的事务基础。然而，当这些流在时间上交错或层次上组合时，会出现一些边界情况。接下来讨论的是 <strong>主设备</strong> 和 <strong>从设备</strong> 之间如<strong>何分配并发管理的责任</strong>。</p><p>TileLink 协议并不假定存在点对点的有序消息传递。实际上，高优先级的消息可以绕过低优先级的消息，即使它们的目标是同一个设备。这意味着，<strong>从设备</strong> 充当了一个便利的同步点，所有与它连接的 <strong>主设备</strong> 都通过它来协调消息流。</p><p>由于每个事务必须通过向从设备发送 <strong>Acquire</strong> 消息来发起，因此从设备能够方便地对事务进行排序。<strong>一个非常安全的实现方式是让从设备一次只接受一个事务</strong>，但是这样做的性能影响非常严重，因此实际上我们可以通过限制代理行为，依然保持正确的事务顺序，同时提高并发性。</p><p>通过对代理行为施加一些限制，我们能够保证即使问题是分布式的，也能够构建出事务的总顺序。图 28 提供了关于每种操作并发性限制的概述。</p><p>TileLink 代理的并发限制最容易通过发起或阻止请求消息来理解。每个请求消息都会生成响应消息，而响应消息最终都能向前推进。但是，在某些条件下，<strong>针对同一数据块的递归请求消息</strong> 在未接收到未处理的响应消息之前，不应被发出。</p><p><strong>Acquire（获取）</strong>
主设备如果该块上有挂起的Grant（授权），则不应发起Acquire请求。发起Acquire后，主设备在收到Grant之前，不应再对该块发起其他Acquire请求。</p><p><strong>Grant（授权）</strong>
从设备如果该块上有挂起的ProbeAck（探针确认），则不应发起Grant授权。一旦发出Grant授权，从设备在收到GrantAck（授权确认）之前，不应对该块发起进一步的Probe请求。</p><p><strong>Release（释放）</strong>
主设备如果该块上有挂起的Grant授权，则不应发起Release请求。发出Release后，主设备在收到Slave确认完成写回的ReleaseAck之前，不应再发起ProbeAcks、Acquires或其他Release请求。</p><p><strong>Probe（探针）</strong>
从设备如果该块上有挂起的GrantAck授权确认，则不应发起Probe请求。一旦发出Probe请求，从设备在收到ProbeAck（探针确认）之前，不应对该块发起进一步的Probe请求。</p><p>总而言之就是如果有*ack的话，就不要发起*</p><p>未完</p><h2 id=附录>附录</h2><h3 id=参考文献>参考文献</h3><p>tilelink_spec_1.8.1</p><h3 id=版权信息>版权信息</h3><p>本文原载于 <a class=link href=https://vastcircle.github.io target=_blank rel=noopener>vastcircle.github.io</a>，遵循 CC BY-NC-SA 4.0 协议，复制请保留原文出处。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/tilelink/>TileLink</a>
<a href=/tags/%E5%8D%8F%E8%AE%AE/>协议</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("//cdn.bootcss.com/pangu/3.3.0/pangu.min.js",function(){pangu.spacingPage()})</script><section class=copyright>&copy;
2023 -
2024 <a href=https://stack-theme-mod.vercel.app/>vastcircle</a>·<i class="fas fa-bell"></i> <a id=days>0</a>Days<br>共书写了89.6k字·共 32篇文章</br><span><p></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a><br><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank>© Licensed Under CC BY-NC-SA 4.0</a></section><script>var days,number_of_days,s1="2024-10-06",s1=new Date(s1.replace(/-/g,"/"));s2=new Date,days=s2.getTime()-s1.getTime(),number_of_days=parseInt(days/(1e3*60*60*24)),document.getElementById("days").innerHTML=number_of_days</script></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><form action=/search/ class="search-form widget"><p><label>Search</label>
<input name=keyword required placeholder="Type something...">
<button title=Search><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></button></p></form><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#概述>概述</a></li><li><a href=#使用-tilelink-实现缓存一致性>使用 TileLink 实现缓存一致性</a><ol><li><a href=#operation>operation</a></li><li><a href=#channels>Channels</a></li><li><a href=#tl-c-messages>TL-C Messages</a></li><li><a href=#permissions-transitons>Permissions Transitons</a></li></ol></li><li><a href=#flows-and-waves>Flows and Waves</a></li><li><a href=#附录>附录</a><ol><li><a href=#参考文献>参考文献</a></li><li><a href=#版权信息>版权信息</a></li></ol></li></ol></nav></div></section><section class="widget categories"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9.828 9.172a4 4 0 100 5.656A10 10 0 0012 12a10 10 0 012.172-2.828 4 4 0 110 5.656A10 10 0 0112 12 10 10 0 009.828 9.172"/></svg></div><h2 class="widget-title section-title">Categories</h2><div class=widget-categories--list><div class=widget><h3 class=widget-title></h3><div class=widget-body><div class=category-list><div class=category-list-item><a href=https://VastCircle.github.io/categories/chipyard/ class=category-list-link>chipyard<span class=category-list-count>3</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/cpu%E5%9F%BA%E7%A1%80/ class=category-list-link>cpu基础<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/linux/ class=category-list-link>linux<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/rocket-chip/ class=category-list-link>rocket-chip<span class=category-list-count>2</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/runahead/ class=category-list-link>runahead<span class=category-list-count>3</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/ class=category-list-link>代码阅读<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/ class=category-list-link>博客搭建<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E5%A4%84%E7%90%86%E5%99%A8/ class=category-list-link>处理器<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/ class=category-list-link>环境配置<span class=category-list-count>2</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/ class=category-list-link>缓存一致性<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/ class=category-list-link>论文阅读<span class=category-list-count>2</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E8%B6%85%E6%A0%87%E9%87%8F%E5%A4%84%E7%90%86%E5%99%A8/ class=category-list-link>超标量处理器<span class=category-list-count>12</a></span></div></div></div></div></div></section><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9.828 9.172a4 4 0 100 5.656A10 10 0 0012 12a10 10 0 012.172-2.828 4 4 0 110 5.656A10 10 0 0112 12 10 10 0 009.828 9.172"/></svg></div><h2 class="widget-title section-title">Archives</h2><div class=widget-archive--list><div class=archives-year><a href=/archives/#2024><span class=year>2024</span>
<span class=count>32</span></a></div></div></section><section class="widget tagCloud"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg></div><h2 class="widget-title section-title">Tags</h2><div class=tagCloud-tags><a href=/tags/runahead/ class=font_size_3>Runahead
</a><a href=/tags/cache/ class=font_size_2>Cache
</a><a href=/tags/chipyard/ class=font_size_2>Chipyard
</a><a href=/tags/rocket-chip/ class=font_size_2>Rocket-Chip
</a><a href=/tags/%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B/ class=font_size_2>分支预测
</a><a href=/tags/%E5%AF%84%E5%AD%98%E5%99%A8%E9%87%8D%E5%91%BD%E5%90%8D/ class=font_size_2>寄存器重命名
</a><a href=/tags/%E6%8F%90%E4%BA%A4/ class=font_size_2>提交
</a><a href=/tags/hugo/ class=font_size_1>Hugo
</a><a href=/tags/in-order/ class=font_size_1>In-Order
</a><a href=/tags/linux/ class=font_size_1>Linux</a></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>