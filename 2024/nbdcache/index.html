<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Dcacheç»“æ„å›¾ image-20241111163907552 '><title>NBDcache</title>
<link rel=canonical href=https://VastCircle.github.io/2024/nbdcache/><link rel=stylesheet href=/scss/style.min.46208cabd58e8bcef0cfb7d7ea6b561adcca3b91dd1fc6657493a44f03c5db75.css><meta property='og:title' content='NBDcache'><meta property='og:description' content='Dcacheç»“æ„å›¾ image-20241111163907552 '><meta property='og:url' content='https://VastCircle.github.io/2024/nbdcache/'><meta property='og:site_name' content="VastCircle's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='rocket-chip'><meta property='article:tag' content='scala'><meta property='article:published_time' content='2024-11-11T16:33:27+08:00'><meta property='article:modified_time' content='2024-11-11T16:33:27+08:00'><meta name=twitter:title content="NBDcache"><meta name=twitter:description content="Dcacheç»“æ„å›¾ image-20241111163907552 "><style>:root{--article-font-family:"Noto Serif SC", var(--base-font-family)}</style><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
<!--
extended
-->
on-phone--column extended"><div id=article-toolbar><a href=https://VastCircle.github.io/ class=back-home><svg class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span></a></div><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><a href=/><img src=/img/avatar_hu9516569771622178000.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>ğŸ¥</span></figure><h1 class=site-name><a href=/>VastCircle's blog</a></h1><h2 class=site-description>To shine , not to be illuminated</h2><ol class=social-menu><li><a href=https://github.com/VastCircle target=_blank title=GitHub><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>friends</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/>ä»£ç é˜…è¯»</a></header><h2 class=article-title><a href=/2024/nbdcache/>NBDcache</a></h2><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 11, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-words>5173å­—</time></div></footer></div></header><section class=article-content><h2 id=dcacheç»“æ„å›¾>Dcacheç»“æ„å›¾</h2><p><figure class=gallery-image style=flex-grow:141;flex-basis:339px><a href=/2024/nbdcache/image-20241111163907552.png data-size=996x705><img src=/2024/nbdcache/image-20241111163907552.png width=996 height=705 srcset="/2024/nbdcache/image-20241111163907552_hu11066709581250157466.png 480w, /2024/nbdcache/image-20241111163907552_hu15637605824835427283.png 1024w" loading=lazy alt=image-20241111163907552></a><figcaption>image-20241111163907552</figcaption></figure></p><h2 id=æ¦‚è¿°>æ¦‚è¿°</h2><p>noblockcache ä¸­å…±ä¾‹åŒ–äº†3ä¸ªå°æ¨¡å—,writebackUnit,ProbeUnit,MSHRFile</p><p>è¯¥Cacheæ”¯æŒä¸»ç¼ºå¤±å’Œæ¬¡ç¼ºå¤±ä¸¤ç§æƒ…å†µã€‚ä¸»ç¼ºå¤±æ˜¯æŒ‡æŸä¸ªç¼“å­˜è¡Œçš„é¦–æ¬¡ç¼ºå¤±ï¼Œå¯¼è‡´å‘ä¸»å­˜å‘é€å›å¡«è¯·æ±‚ï¼›è€Œæ¬¡ç¼ºå¤±åˆ™æ˜¯æŒ‡å¯¹ç¼“å­˜çš„è®¿é—®ä¹Ÿå‘ç”Ÿç¼ºå¤±ï¼Œä½†ç›®æ ‡ç¼“å­˜è¡Œä¸ä¹‹å‰çš„ä¸»ç¼ºå¤±æ˜¯åŒä¸€ä¸ªã€‚</p><p>åœ¨MSHRï¼ˆç¼ºå¤±çŠ¶æ€ä¿æŒå¯„å­˜å™¨ï¼‰ä¸­ï¼Œé€šè¿‡ä¸»ç¼ºå¤±æ ‡ç­¾å’Œé‡æ”¾é˜Ÿåˆ—æ¥è·Ÿè¸ªç¼ºå¤±ã€‚ä¸»ç¼ºå¤±æ ‡ç­¾è®°å½•å¤„äºå¤„ç†ä¸­çš„å›å¡«è¯·æ±‚çš„åœ°å€ï¼Œå¹¶åœ¨æ¯æ¬¡ç¼ºå¤±æ—¶è¢«æœç´¢ï¼Œä»¥åˆ¤æ–­æ˜¯å¦ä¸ºæ¬¡ç¼ºå¤±ã€‚å‘ç”Ÿä¸»ç¼ºå¤±æ—¶ï¼Œä¼šåˆ†é…ä¸€ä¸ªæ–°çš„ä¸»ç¼ºå¤±æ ‡ç­¾æ¥è®°å½•åœ°å€ï¼Œå‘å‡ºå›å¡«è¯·æ±‚ï¼Œå¿…è¦æ—¶æ‰§è¡Œé©±é€ï¼ˆevictionï¼‰ï¼Œå¹¶åœ¨ä¸»ç¼ºå¤±æ ‡ç­¾æ—çš„é“¾è¡¨ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„é‡æ”¾é˜Ÿåˆ—æ¡ç›®ã€‚é‡æ”¾é˜Ÿåˆ—æ¡ç›®åŒ…å«å…³äºè®¿é—®çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬å¯¹åº”çš„ç¼“å­˜è¡Œåç§»é‡ã€å­—èŠ‚å®½åº¦ã€ç”¨äºåŠ è½½çš„ç›®æ ‡å¯„å­˜å™¨ä»¥åŠå¾…å­˜å‚¨çš„æ•°æ®ã€‚</p><p>æ¬¡ç¼ºå¤±ä¼šåœ¨å¯¹åº”çš„é‡æ”¾é˜Ÿåˆ—ä¸­æ·»åŠ æ–°çš„æ¡ç›®ï¼Œä½†ä¸ä¼šå‘ä¸»å­˜å‘é€é¢å¤–çš„å›å¡«è¯·æ±‚ã€‚</p><p>The cache supports both primary misses and secondary misses. A primary miss is the first miss to a cache line and causes a refill request to be sent to main memory, while secondary misses are accesses which miss in the cache but are for the same cache line as an earlier primary miss.</p><p>Misses are tracked in the MSHR using primary miss tags and replay queues. Primary miss tags hold the address of an in-flight refill request and are searched on every miss to determine if it is a secondary miss. A primary miss allocates a new primary miss tag to hold the address, issues a refill request, performs an eviction if needed, and adds a new replay queue entry to a linked list next to the primary miss tag. Replay queue entries contain information about the access including the corresponding cache line offset, the byte width, the destination register for loads, and pending data for stores. A secondary miss adds a new replay queue entry to the appropriate replay queue, but does not send an additional refill request to main memory</p><h2 id=æ¨¡å—ä»‹ç»>æ¨¡å—ä»‹ç»</h2><h3 id=nonblockingdcachemodule>NonBlockingDCacheModule</h3><p>ç›®å‰é…ç½®çš„dcache , 16è·¯</p><p>â€‹ d-cache-block-size = &lt;64>;
â€‹ d-cache-sets = &lt;16>;
â€‹ d-cache-size = &lt;4096></p><p>4è·¯ç»„ç›¸è”cache 4096/16/64=4</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>s1_req</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Reg</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>HellaCacheReq</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// s1ä¸»è¦æ˜¯æ‰“äº†ä¸€æ‹,ä¸‹é¢å…¶å®æ˜¯åœ¨å†³å®šæŠŠä»€ä¹ˆæ•°æ®æ‰“ä¸€æ‹ï¼Œç¬¬ä¸€æ‹å°±æ˜¯åœ¨ä»²è£ä»€ä¹ˆæ•°æ®åœ°å€è¯¥å»è¯»dataå’Œmeta 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// cpu_req : cpuçš„è¯·æ±‚ä¿¡å·
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cpu</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cpu</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// å†™å›moduleçš„è¯·æ±‚ä¿¡å·
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>wb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Cat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>wb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>wb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>blockOffBits</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>phys</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// æ§åˆ¶moduleçš„è¯·æ±‚ä¿¡å·
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>prober</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Cat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>prober</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>prober</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>blockOffBits</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>phys</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>s2_recycle</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s2_req</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>s1_clk_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#7f848e>//TODO: should be metaReadArb.io.out.fire, but triggers Verilog backend bug
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// metaReadArbæŒ‰ç†æœ‰5ä¸ªç«¯å£,ä½†æ˜¯ç”Ÿæˆçš„æ—¶å€™ç«¯å£0è²Œä¼¼è¢«ä¼˜åŒ–äº†
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s2_recycle</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s2_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>blockOffBits</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>~</span><span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s2_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>2</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>prober</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>3</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>wb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>4</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cpu</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>4</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cpu</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>blockOffBits</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>4</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cpu</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>untagBits</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>4</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>~</span><span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>)</span>
</span></span></code></pre></div><h3 id=wbu>WBU</h3><p><code>WritebackUnit</code> æ¨¡å—å®ç°äº†ä¸€ä¸ªç¼“å­˜çš„å†™å›å•å…ƒï¼Œè´Ÿè´£é€šè¿‡ TL-C çš„ C é€šé“å‘ L2 Cache é‡Šæ”¾æ›¿æ¢å— (Release)ã€‚</p><p><code>refillCycles</code> è¡¨ç¤ºåœ¨å‘ç”Ÿç¼“å­˜æœªå‘½ä¸­ï¼ˆcache missï¼‰æ—¶ï¼Œä»ä¸»å­˜æˆ–å…¶ä»–ç¼“å­˜ä¸­è¯»å–æ•°æ®å¹¶å°†å…¶å¡«å……åˆ°ç›®æ ‡ç¼“å­˜çš„è¿‡ç¨‹æ‰€éœ€çš„æ—¶é’Ÿå‘¨æœŸæ•°</p><p>éœ€è¦wbuçš„moduleåªæœ‰ prober å’Œ mshrs , proberå’Œwbuçš„æ•°æ®éƒ½æ˜¯é€šè¿‡cé€šé“è¿›è¡Œå›å¤çš„</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#e06c75>wbArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>prober</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>wbArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>wb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>wbArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>active</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>r1_data_req_fired</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>false</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>r2_data_req_fired</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>r1_data_req_fired</span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// è¿”å›æ•°æ®å¹¶ä¸”è¿”å›tagçš„æ—¶å€™
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>      <span style=color:#7f848e>// æ‹‰é«˜r1_data_req_fired 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>      <span style=color:#e06c75>r1_data_req_fired</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>      <span style=color:#7f848e>// è®¡æ•°å™¨+1
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>      <span style=color:#e06c75>data_req_cnt</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>data_req_cnt</span> <span style=color:#56b6c2>+</span> <span style=color:#d19a66>1.</span><span style=color:#e06c75>U</span>
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>r2_data_req_fired</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>      <span style=color:#7f848e>// åœ¨è¿”å›åçš„ç¬¬äºŒæ‹,æ‹‰é«˜release.valid 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>      <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>release</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>when</span><span style=color:#56b6c2>(!</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>release</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>r1_data_req_fired</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>false</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>r2_data_req_fired</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>false</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#7f848e>// ä¸€èˆ¬éƒ½æ˜¯å‡å»2,é™¤érefilllCycles &lt;= 1
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>        <span style=color:#e06c75>data_req_cnt</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>data_req_cnt</span> <span style=color:#56b6c2>-</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>[</span><span style=color:#e5c07b>UInt</span><span style=color:#56b6c2>]((</span><span style=color:#e06c75>refillCycles</span> <span style=color:#56b6c2>&gt;</span> <span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>B</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>r1_data_req_fired</span><span style=color:#56b6c2>,</span> <span style=color:#d19a66>2.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>,</span> <span style=color:#d19a66>1.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>      <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>when</span><span style=color:#56b6c2>(!</span><span style=color:#e06c75>r1_data_req_fired</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>        <span style=color:#7f848e>// We&#39;re done if this is the final data request and the Release can be sent
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>        <span style=color:#e06c75>active</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>data_req_cnt</span> <span style=color:#56b6c2>&lt;</span> <span style=color:#e06c75>refillCycles</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span> <span style=color:#56b6c2>||</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>release</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span>
</span></span><span style=display:flex><span>      <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span> <span style=color:#7f848e>// å‘èµ·è¯·æ±‚çš„æ—¶å€™è¿›è¡Œactive å’Œ èµ‹å€¼ 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>active</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>data_req_cnt</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>fire</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>(</span><span style=color:#c678dd>if</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>refillCycles</span> <span style=color:#56b6c2>&gt;</span> <span style=color:#d19a66>1</span><span style=color:#56b6c2>)</span> 
</span></span><span style=display:flex><span>                              <span style=color:#e5c07b>Cat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>data_req_cnt</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>log2Up</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>refillCycles</span><span style=color:#56b6c2>)-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>                            <span style=color:#c678dd>else</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>rowOffBits</span>
</span></span></code></pre></div><h3 id=probe>Probe</h3><p>å®ç°äº†Cacheç®¡ç†æ¨¡å—çš„çŠ¶æ€æœºï¼Œä¸»è¦ç”¨äºå¤„ç†æ¢æµ‹è¯·æ±‚çš„æ“ä½œï¼Œç®¡ç†Cacheçš„çŠ¶æ€ï¼Œåˆ¤æ–­å‘½ä¸­æƒ…å†µï¼Œä»¥åŠå¤„ç†æ•°æ®å†™å›æ“ä½œ,ä¸»è¦é’ˆå¯¹çš„æ˜¯tag,ä¸æ˜¯data</p><p><del>proberçš„è¯·æ±‚è¾“å…¥çš„æ•°æ®ä¸æ˜¯cpu_req,è€Œæ˜¯auto_out_b_ , ä»£è¡¨è¿™æ˜¯ä¸‹ä¸€çº§å­˜å‚¨l2ï¼Œæ¯”æ–¹è¯´å¤–è®¾å‘èµ·çš„è¯»æ•°æ®ï¼Œæˆ–è€…åœ¨å¤šæ ¸å¿ƒçš„æƒ…å†µä¸‹ï¼Œcore0å»è¯»cache0,ä¸ºäº†ç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œå¯èƒ½éœ€è¦sbuså»è¯»cache1ï¼Œç„¶åå†å»å†™cache0ç­‰</del></p><p>proberåº”è¯¥å°±æ˜¯å»æŠŠdcacheçš„å†…å®¹ç»™disabledå¹¶ä¸”å†™å…¥l2 cacheçš„</p><p>å‘èµ·auto_out_b_*çš„æ˜¯l2 cache</p><p><figure class=gallery-image style=flex-grow:436;flex-basis:1047px><a href=/2024/nbdcache/image-20241120205937336.png data-size=825x189><img src=/2024/nbdcache/image-20241120205937336.png width=825 height=189 srcset="/2024/nbdcache/image-20241120205937336_hu10158162628482713343.png 480w, /2024/nbdcache/image-20241120205937336_hu8485362152773789671.png 1024w" loading=lazy></a></figure></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#7f848e>// 9ä¸ªçŠ¶æ€
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>val</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>s_invalid</span> <span style=color:#c678dd>:</span><span style=color:#e5c07b>:</span> <span style=color:#e5c07b>s_meta_read</span> <span style=color:#e5c07b>::</span> <span style=color:#e5c07b>s_meta_resp</span> <span style=color:#e5c07b>::</span> <span style=color:#e5c07b>s_mshr_req</span> <span style=color:#e5c07b>::</span>
</span></span><span style=display:flex><span>       <span style=color:#e06c75>s_mshr_resp</span> <span style=color:#c678dd>:</span><span style=color:#e5c07b>:</span> <span style=color:#e5c07b>s_release</span> <span style=color:#e5c07b>::</span> <span style=color:#e5c07b>s_writeback_req</span> <span style=color:#e5c07b>::</span> <span style=color:#e5c07b>s_writeback_resp</span> <span style=color:#e5c07b>::</span> 
</span></span><span style=display:flex><span>       <span style=color:#e06c75>s_meta_write</span> <span style=color:#c678dd>:</span><span style=color:#e5c07b>:</span> <span style=color:#e5c07b>Nil</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Enum</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>9</span><span style=color:#56b6c2>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_resp</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// we need to wait one cycle for the metadata to be read from the array
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_meta_resp</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_mshr_req</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_mshr_req</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>old_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>block_state</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// æ¯”è¾ƒæœ‰æ„æ€,å¦‚æœæ²¡æœ‰rdy,ä¸æ˜¯é€‰æ‹©wait,è€Œæ˜¯retry
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>// if the read didn&#39;t go through, we need to retry
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mshr_rdy</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_mshr_resp</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_meta_read</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// å¦‚æœæ˜¯è„æ•°æ®çš„è¯ï¼Œå°±è¦å†™å›åˆ°l2, åä¹‹éœ€è¦é‡Šæ”¾ç›¸åº”çš„æƒé™ï¼ˆæˆ‘è§‰å¾—ä¸»è¦å°±æ˜¯æƒé™çš„æ”¹å˜ï¼Œä½†æ˜¯ä¸éœ€è¦ä¼´éšæ•°æ®ï¼‰
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_mshr_resp</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>tag_matches</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>is_dirty</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_writeback_req</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_release</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_release</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>rep</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>tag_matches</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_meta_write</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_invalid</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#7f848e>// ä¸ç®¡æ€ä¹ˆæ ·ï¼Œæœ€åä¸€æ­¥éƒ½æ˜¯write_meta 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span> <span style=color:#7f848e>// wait for the writeback request to finish before updating the metadata
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span> <span style=color:#7f848e>// meta write åº”è¯¥æœ‰å°†æ”¹å˜çš„æƒé™å†™å…¥meta 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_writeback_resp</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_write</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span></code></pre></div><p>é€»è¾‘æ˜¯æ¯”è¾ƒç®€å•çš„,å°±æ˜¯å½“å‘èµ·è¯·æ±‚æ—¶,å»meta_read,meta_readä¹‹åå»è¯»mshr,è¯»å‡ºmshrä¹‹å,å½“tag_matchçš„æ—¶å€™ä¸”ä¸ºdirty,éœ€è¦å†™å›,æ‰€ä»¥åˆ‡æ¢åˆ°s_writeback_req ,å¦åˆ™åˆ°release,releaseä¹‹åå»meta_write.å†™å›æ˜¯ç”±wbæ¨¡å—æ§åˆ¶çš„</p><p>bé€šé“æ‰¾ä¸åˆ°opcode,ä½†å’Œprobeç›¸å…³æ˜¯è‚¯å®šçš„ï¼Œparamä»£è¡¨10,å’Œcä¸€è‡´</p><p>cé€šé“æ˜¯probe_ack , c_paramæŒ‡ç¤ºç”±äºæ¢æµ‹è€Œåœ¨ä¸»ä»£ç†ä¸­å‘ç”Ÿçš„ç‰¹å®šç±»å‹çš„æƒé™æ›´æ”¹,</p><p>å¦‚ä¸‹ä»£è¡¨probe_ack , BtoN ,é™æƒé™çš„</p><p><figure class=gallery-image style=flex-grow:325;flex-basis:780px><a href=/2024/nbdcache/image-20241122205333780.png data-size=1369x421><img src=/2024/nbdcache/image-20241122205333780.png width=1369 height=421 srcset="/2024/nbdcache/image-20241122205333780_hu6178936314293379860.png 480w, /2024/nbdcache/image-20241122205333780_hu14194576438853189490.png 1024w" loading=lazy></a></figure></p><p>å¦‚æœæ˜¯é€šè¿‡wbå†™å›çš„è¯ï¼Œcé€šé“è¿”å›å°±æ˜¯probe_ackdata ,TtoB,æƒé™é™åˆ°å¯è¯»</p><h3 id=l1metadataarray-mata>L1MetadataArray mata</h3><p>metaå°±æ˜¯å­˜å‚¨tagçš„åœ°æ–¹,æ˜¯ä¸€ä¸ªåŒæ­¥ram</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#7f848e>// () =&gt; Tæ˜¯å‡½æ•°çš„å†™æ³• ,æ— è¾“å…¥å‚æ•°,è¾“å‡ºå‚æ•°æ˜¯Tç±»å‹çš„
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>L1MetadataArray</span><span style=color:#56b6c2>[</span><span style=color:#e5c07b>T</span> <span style=color:#c678dd>&lt;:</span> <span style=color:#e5c07b>L1Metadata</span><span style=color:#56b6c2>](</span><span style=color:#e06c75>onReset</span><span style=color:#c678dd>:</span> <span style=color:#56b6c2>()</span> <span style=color:#56b6c2>=&gt;</span> <span style=color:#e06c75>T</span><span style=color:#56b6c2>)(</span><span style=color:#c678dd>implicit</span> <span style=color:#e06c75>p</span><span style=color:#c678dd>:</span> <span style=color:#e5c07b>Parameters</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>extends</span> <span style=color:#e06c75>L1HellaCacheModule</span><span style=color:#56b6c2>()(</span><span style=color:#e06c75>p</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>rstVal</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>onReset</span><span style=color:#56b6c2>()</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>io</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>IO</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>Bundle</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>read</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Flipped</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Decoupled</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e06c75>L1MetaReadReq</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>write</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Flipped</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Decoupled</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e06c75>L1MetaWriteReq</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>resp</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Output</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Vec</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>rstVal</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cloneType</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>rst_cnt</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>RegInit</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>log2Up</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nSets</span><span style=color:#56b6c2>+</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>rst</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>rst_cnt</span> <span style=color:#56b6c2>&lt;</span> <span style=color:#e06c75>nSets</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>waddr</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>rst</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>rst_cnt</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>wdata</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>rst</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>rstVal</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>asUInt</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// way_enæ˜¯ç‹¬çƒ­ç çš„å½¢å¼
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>wmask</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>rst</span> <span style=color:#56b6c2>||</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span> <span style=color:#56b6c2>==</span> <span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>B</span><span style=color:#56b6c2>,</span> <span style=color:#56b6c2>(-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>S</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>asSInt</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>asBools</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>rmask</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>rst</span> <span style=color:#56b6c2>||</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span> <span style=color:#56b6c2>==</span> <span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>B</span><span style=color:#56b6c2>,</span> <span style=color:#56b6c2>(-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>S</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>asSInt</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>asBools</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>rst</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#e06c75>rst_cnt</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>rst_cnt</span><span style=color:#56b6c2>+</span><span style=color:#d19a66>1.</span><span style=color:#e06c75>U</span> <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>metabits</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>rstVal</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>getWidth</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// way æ˜¯è·¯æ•° , setsæ˜¯ç»„æ•° , way_en å°±æ˜¯ç”¨æ¥é€‰æ‹©è·¯çš„
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// åŒæ­¥mem
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>tag_array</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>SyncReadMem</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nSets</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>Vec</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>UInt</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>metabits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>)))</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>wen</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>rst</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>wen</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>tag_array</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>waddr</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>VecInit</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fill</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>)(</span><span style=color:#e06c75>wdata</span><span style=color:#56b6c2>),</span> <span style=color:#e06c75>wmask</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// read data 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>resp</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>tag_array</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>read</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>,</span>          <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>()).</span><span style=color:#e06c75>map</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>_</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>asTypeOf</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>chiselTypeOf</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>rstVal</span><span style=color:#56b6c2>)))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>wen</span> <span style=color:#7f848e>// so really this could be a 6T RAM
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>rst</span>
</span></span><span style=display:flex><span><span style=color:#56b6c2>}</span>
</span></span></code></pre></div><h3 id=metareadarb-or-metawritearb>metaReadArb or metaWriteArb</h3><p>metaReadArbä»²è£è¾“å…¥ä¸º mshrs , prober , wb ,<strong>mata å’Œ dataéƒ½æ”¯æŒå¤šè·¯è¯»å–</strong></p><h3 id=mshrfile>MSHRFile</h3><p>ç¼“å­˜æ§åˆ¶ä¸­çš„å…³é”®éƒ¨åˆ†ï¼Œç”¨äºå¤„ç†å¤šç»„MSHRï¼ˆMiss Status Holding Registerï¼‰ï¼Œåè°ƒå¤šç§è¯·æ±‚ï¼ˆè¯»ã€å†™ã€å¡«å……ã€å†™å›ç­‰ï¼‰åœ¨ä¸€çº§ç¼“å­˜ï¼ˆL1 Cacheï¼‰ä¸­çš„æ“ä½œã€‚</p><p>é¡¶å±‚è¾“å…¥çš„æ¯ä¸€ä¸ªreqä¼šå‘é€åˆ°æ¯ä¸€ä¸ªmshrä¸­ï¼Œä½†æ˜¯æœ€ç»ˆåªæœ‰ä¸€ä¸ªmshrä¼šè¢«é€‰ä¸­ ï¼Œä¹Ÿå°±ä»£è¡¨åªæœ‰ä¸€ä¸ªmshrä¼šè¢«å†™å…¥æœ¬ç¬”æ•°æ®</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_sec_val</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>sdq_rdy</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>tag_match</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>viewAsSupertype</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>HellaCacheReqInternal</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>viewAsSupertype</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>HellaCacheReqInternal</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag_match</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag_match</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>old_meta</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>old_meta</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>sdq_id</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>sdq_alloc_id</span>
</span></span></code></pre></div><h4 id=cacheable>cacheable</h4><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#c678dd>val</span> <span style=color:#e06c75>cacheable</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>edge</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>manager</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>supportsAcquireBFast</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>lgCacheBlockBytes</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>)</span>
</span></span></code></pre></div><p><code>cacheable</code>ç”¨äºæ£€æµ‹å½“å‰è¯·æ±‚çš„åœ°å€æ˜¯å¦å¯ä»¥è¢«ç¼“å­˜ã€‚<code>edge.manager.supportsAcquireBFast</code>æ–¹æ³•æ£€æŸ¥ç¼“å­˜æ§åˆ¶å™¨æ˜¯å¦æ”¯æŒå¿«é€Ÿè·å–æ“ä½œã€‚</p><h4 id=sdq>sdq</h4><p>ç”¨äºç®¡ç†store data queue</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span> <span style=color:#7f848e>// ä½å‘é‡å¯„å­˜å™¨ï¼Œç”¨äºè·Ÿè¸ªSDQä¸­çš„ç©ºé—²æ¡ç›®ã€‚æ¯ä¸€ä½ä»£è¡¨ä¸€ä¸ªä½ç½®ï¼Œå¦‚æœä¸º1åˆ™è¡¨ç¤ºè¯¥ä½ç½®å·²è¢«åˆ†é…ï¼Œè‹¥ä¸º0åˆ™è¡¨ç¤ºç©ºé—²
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>sdq_val</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>RegInit</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// é€šè¿‡ä¼˜å…ˆç¼–ç è·å–å…¶ä¸­ä¸€ä¸ªç©ºé—²çš„sdqçš„id,ä»å·¦å¾€å³ç¬¬ä¸€ä¸ª0  
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// æ¯”æ–¹è¯´ priorityEncoder(0b0100) = 2 ,priorityEncoder(0b0111) = 2 ,ç‹¬çƒ­è½¬æ•°å€¼ 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>sdq_alloc_id</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>PriorityEncoder</span><span style=color:#56b6c2>(~</span><span style=color:#e06c75>sdq_val</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// å¦‚æœä¸æ˜¯å…¨éƒ¨ä¸º1ä»£è¡¨æœ‰ç©ºé—²,è®¾ä¸ºready 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>sdq_rdy</span> <span style=color:#c678dd>=</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>sdq_val</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>andR</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// è¡¨ç¤ºå½“å‰è¯·æ±‚æ˜¯å¦æ»¡è¶³å†™å…¥SDQçš„æ¡ä»¶ ,éœ€è¦è¯·æ±‚æœ‰æ•ˆ,è¯·æ±‚èƒ½å¤Ÿè¢«æ¥å—,å¯ç¼“å­˜,å¹¶ä¸”æ˜¯å†™å‘½ä»¤ 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>sdq_enq</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>cacheable</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>isWrite</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// store data queue ,å­˜æ”¾æ•°æ® 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>sdq</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mem</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>UInt</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>coreDataBits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>))</span> 
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// å½“æ»¡è¶³æ¡ä»¶,å°±å†™å…¥ç›¸åº”æ•°æ® 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>sdq_enq</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#e06c75>sdq</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>sdq_alloc_id</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span> <span style=color:#56b6c2>}</span> 
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// ç”¨äºæŒ‡ç¤ºæ˜¯å¦å¯ä»¥é‡Šæ”¾å­˜å‚¨æ•°æ®é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªæ¡ç›®,å½“io.replay.fireï¼ˆå³é‡æ”¾è¯·æ±‚æœ‰æ•ˆä¸”è¢«æ¥å—ï¼‰ä¸”å½“å‰é‡æ”¾æŒ‡ä»¤æ˜¯å†™æ“ä½œï¼ˆisWrite(io.replay.bits.cmd)ï¼‰æ—¶ï¼Œfree_sdqä¸ºtrueï¼Œè¡¨ç¤ºå¯ä»¥é‡Šæ”¾è¯¥æ¡ç›®ã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>free_sdq</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>isWrite</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>sdq</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>RegEnable</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>replay_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>sdq_id</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>free_sdq</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mask</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>replay_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// sdq_enqä»£è¡¨è¦å»åˆ†é…sdqäº†  io_replay.valid ä»£è¡¨sdqä½¿ç”¨å®Œäº†  
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// uIntToOH(3) = 0b0100 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// priotityEncoderOHæŠŠæœ€é è¿‘å·¦è¾¹çš„1 set  , æ¯”æ–¹è¯´ sdq_val = 0b0011, åˆ™ priorityEncoderOH(~sdq_val(cfg.SDQ-1,0)) = 0b0010 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>sdq_enq</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>sdq_val</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>sdq_val</span> <span style=color:#56b6c2>&amp;</span> <span style=color:#56b6c2>~(</span><span style=color:#e5c07b>UIntToOH</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>replay_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>sdq_id</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&amp;</span> <span style=color:#e5c07b>Fill</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>free_sdq</span><span style=color:#56b6c2>))</span> <span style=color:#7f848e>// reset 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>                       <span style=color:#56b6c2>|</span> <span style=color:#e5c07b>PriorityEncoderOH</span><span style=color:#56b6c2>(~</span><span style=color:#e06c75>sdq_val</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>))</span> <span style=color:#56b6c2>&amp;</span> <span style=color:#e5c07b>Fill</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>sdq_enq</span><span style=color:#56b6c2>)</span>  <span style=color:#7f848e>// set
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>replay_arb</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Module</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>Arbiter</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>ReplayInternal</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nMSHRs</span><span style=color:#56b6c2>))</span>
</span></span></code></pre></div><h4 id=iomshr>iomshr</h4><p>è¾“å…¥æ˜¯s2_req ï¼Œ å›åº”respï¼Œè¿™é‡Œçš„respæ˜¯ç›´æ¥æ¥å…¥åˆ°MSHRfileé¡¶å±‚ç«¯å£çš„ï¼Œå®ƒå’Œmshræ˜¯åŒä¸€ç±»ä¸œè¥¿ï¼Œåº”è¯¥å°±æ˜¯mmio,å°±æ˜¯ä¸ç»è¿‡cacheçš„æ•°æ®,ä½†æ˜¯æœ¬èº«mshrä¿å­˜çš„æ˜¯ç¼“å­˜æœªå‘½ä¸­çš„è¯·æ±‚ä»¥åŠç›¸å…³çŠ¶æ€ï¼Œå±‚æ¬¡æœ‰ç‚¹é—®é¢˜å§</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#e06c75>mmio_alloc_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>cacheable</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span> <span style=color:#c678dd>val</span> <span style=color:#e06c75>io</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>IO</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>Bundle</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>req</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Flipped</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Decoupled</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>HellaCacheReq</span><span style=color:#56b6c2>))</span>          <span style=color:#7f848e>// MSHRfileå‘èµ·çš„req 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>resp</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Decoupled</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>HellaCacheResp</span><span style=color:#56b6c2>)</span>                 <span style=color:#7f848e>// resp 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>mem_access</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Decoupled</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>TLBundleA</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>edge</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bundle</span><span style=color:#56b6c2>))</span>   <span style=color:#7f848e>// å‘memå‘èµ·çš„è¯·æ±‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>mem_ack</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Flipped</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Valid</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>TLBundleD</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>edge</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bundle</span><span style=color:#56b6c2>)))</span> <span style=color:#7f848e>// mem ack 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>replay_next</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Output</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Bool</span><span style=color:#56b6c2>())</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>})</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#7f848e>// è¾“å…¥æ¡æ‰‹çš„æ—¶å€™ï¼Œè·å–æ•°æ® req  stage 3 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_mem_access</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span> <span style=color:#7f848e>// è·å–å†…å­˜æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_access</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_mem_ack</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// å†…å­˜æ•°æ®å“åº”
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_mem_ack</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_ack</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_resp</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>isRead</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>))</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>      <span style=color:#7f848e>// è·å–å“åº”çš„æ•°æ®
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>      <span style=color:#e06c75>grant_word</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>wordFromBeat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_ack</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// å‘å‡ºå»äº†
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>resp</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_idle</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span></code></pre></div><p><figure class=gallery-image style=flex-grow:212;flex-basis:508px><a href=/2024/nbdcache/image-20241118210021805.png data-size=844x398><img src=/2024/nbdcache/image-20241118210021805.png width=844 height=398 srcset="/2024/nbdcache/image-20241118210021805_hu12660496501136547085.png 480w, /2024/nbdcache/image-20241118210021805_hu18334060945906226560.png 1024w" loading=lazy></a></figure></p><p>å…¶å®è¿™ä¸ªä»²è£å™¨åƒæ˜¯å€’ç€ç”¨çš„ï¼Œæ˜¯æŠŠio.reqä¿¡å·å»é€‰æ‹©ä¸€ä¸ªmshrå»è¾“å‡º</p><h4 id=mshr>mshr</h4><p>è¾“å…¥æ˜¯s2_req</p><p>æ¯ä¸ªMSHRå¤„ç†ä¸€ä¸ªç¼“å­˜å—çš„ç¼ºå¤±è¯·æ±‚</p><p>mshråº”è¯¥å°±æ˜¯å…¶ä¸­çš„ä¸€ä¸ªè¡¨é¡¹,è¿™é‡Œé€šè¿‡çŠ¶æ€æœºæ¥åˆ¤æ–­è¡¨é¡¹æ˜¯ä¸€æ¬¡ç¼ºå¤±è¿˜æ˜¯äºŒæ¬¡ç¼ºå¤± ,æ˜¯ä¸æ˜¯å¤ªå¥¢ä¾ˆäº†</p><p>è¯¥æ¨¡å—çš„ä¸»è¦åŠŸèƒ½æ˜¯ç®¡ç†å’Œåè°ƒå¤šç§ç¼“å­˜æ“ä½œï¼Œ</p><ol><li>å¤„ç†ç¼“å­˜æœªå‘½ä¸­æ—¶çš„è¯·æ±‚ã€‚</li><li>å‘ä¸»å­˜å‘å‡ºè¯·æ±‚å¹¶ç­‰å¾…å“åº”ã€‚</li><li>ç»´æŠ¤çŠ¶æ€æœºä»¥è·Ÿè¸ªè¯·æ±‚çš„è¿›åº¦ã€‚</li><li>æ ¹æ®ä¸åŒæƒ…å†µæ‰§è¡Œä¸åŒçš„æ§åˆ¶æµã€‚</li></ol><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>idxMatch</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Wire</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Vec</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nMSHRs</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>Bool</span><span style=color:#56b6c2>()))</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>tagList</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Wire</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Vec</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nMSHRs</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>Bits</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>tagBits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>)))</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// idxMatch åªæœ‰ä¸€ä¸ªä¼šæ‹‰é«˜
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>tag_match</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux1H</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>idxMatch</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>tagList</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>untagBits</span>
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><h5 id=çŠ¶æ€è½¬ç§»åŠç›¸åº”è¾“å‡º>çŠ¶æ€è½¬ç§»åŠç›¸åº”è¾“å‡º</h5><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#7f848e>// state æ˜¯ä¸€ä¸ªå¯„å­˜å™¨ï¼Œç”¨äºè·Ÿè¸ª MSHR çš„çŠ¶æ€ã€‚çŠ¶æ€æœºçš„ä¸»è¦çŠ¶æ€åŒ…æ‹¬ï¼š
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_invalidï¼šç©ºé—²çŠ¶æ€ï¼Œè¡¨ç¤º MSHR æœªè¢«å ç”¨ã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_wb_req å’Œ s_wb_respï¼šå¤„ç†å†™å›æ“ä½œçš„çŠ¶æ€ã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_meta_clearï¼šæ¸…ç†ç¼“å­˜å…ƒæ•°æ®ã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_refill_req å’Œ s_refill_respï¼šå¤„ç†ä»ä¸»å­˜ä¸­è·å–æ•°æ®çš„è¯·æ±‚ã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_meta_write_req å’Œ s_meta_write_respï¼šæ›´æ–°ç¼“å­˜å…ƒæ•°æ®ã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_drain_rpqï¼šå¤„ç†é‡æ”¾é˜Ÿåˆ—çš„è¯·æ±‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span> <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_drain_rpq</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>deq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_invalid</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_meta_write_resp</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// this wait state allows us to catch RAW hazards on the tags via nack_victim
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_drain_rpq</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_meta_write_req</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_write_resp</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_refill_resp</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>refill_done</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>new_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>coh_on_grant</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_write_req</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_acquire</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#7f848e>// s_refill_req
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_refill_resp</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_meta_clear</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_refill_req</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_wb_resp</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>acked</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_clear</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#7f848e>// s_wb_req
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_wb_resp</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_sec_val</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_sec_rdy</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#7f848e>// s_wb_req, s_wb_resp, s_refill_req
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//If we get a secondary miss that needs more permissions before we&#39;ve sent
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//  out the primary miss&#39;s Acquire, we can upgrade the permissions we&#39;re 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//  going to ask for in s_refill_req
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>dirtier_cmd</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>is_hit_again</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>new_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>dirtier_coh</span>
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span> 
</span></span><span style=display:flex><span><span style=color:#7f848e>// é¦–æ¬¡missçš„æ—¶å€™,èµ‹å€¼req, è¿™è¯´æ˜reqæ˜¯è¢«ä¿å­˜åœ¨mshrä¸Šçš„,åªæœ‰é¦–æ¬¡ç¼ºå¤±æ‰ä¼šæ”¹å˜
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_val</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_rdy</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>acked</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>false</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>old_coh</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>old_meta</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>coh</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>needs_wb</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>old_coh</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>onCacheControl</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>M_FLUSH</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>_1</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>is_hit</span><span style=color:#56b6c2>,</span> <span style=color:#c678dd>_</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>coh_on_hit</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>old_coh</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>onAccess</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// å¦‚æœå‘½ä¸­ï¼š
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//æ›´æ–°ä¸€è‡´æ€§çŠ¶æ€ï¼šå°†new_cohè®¾ä¸ºcoh_on_hitã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//è®¾ç½®çŠ¶æ€ä¸ºMetaWriteï¼šå‡†å¤‡å†™å›å…ƒæ•°æ®ã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//å¦‚æœæœªå‘½ä¸­ä½†æ ‡è®°åŒ¹é…ï¼š
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//ä¿æŒä¸€è‡´æ€§çŠ¶æ€ä¸å˜ã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//çŠ¶æ€è½¬ä¸ºRefillï¼šå‡†å¤‡è¯·æ±‚æ–°çš„æ•°æ®ã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag_match</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>is_hit</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#7f848e>// set dirty bit
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>        <span style=color:#e06c75>new_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>coh_on_hit</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_write_req</span>
</span></span><span style=display:flex><span>      <span style=color:#56b6c2>}.</span><span style=color:#e06c75>otherwise</span> <span style=color:#56b6c2>{</span> <span style=color:#7f848e>// upgrade permissions
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>        <span style=color:#e06c75>new_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>old_coh</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_refill_req</span>
</span></span><span style=display:flex><span>      <span style=color:#56b6c2>}</span> 
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}.</span><span style=color:#e06c75>otherwise</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>        <span style=color:#7f848e>// writback if necessary and refill æ ‡è®°ä¸åŒ¹é…ï¼šåˆ¤æ–­æ˜¯å¦éœ€è¦å†™å›æ—§æ•°æ®ï¼Œå¹¶å‡†å¤‡åŠ è½½æ–°æ•°æ®ã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>      <span style=color:#e06c75>new_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>ClientMetadata</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>onReset</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>needs_wb</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_wb_req</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_meta_clear</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// state === s_meta_write_req or s_mata_clear 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>isOneOf</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>s_meta_write_req</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_meta_clear</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req_idx</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_meta_clear</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>coh_on_clear</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>new_coh</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// state === s_wb_req 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_wb_req</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>source</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>id</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>old_meta</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req_idx</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>param</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>shrink_param</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>voluntary</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// state === s_refill_req 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_acquire</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_refill_req</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>grantackq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>enq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_acquire</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>edge</span><span style=color:#56b6c2>.</span><span style=color:#e5c07b>AcquireBlock</span><span style=color:#56b6c2>(</span>
</span></span><span style=display:flex><span>                                <span style=color:#e06c75>fromSource</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>id</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#e06c75>toAddress</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Cat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>req_idx</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#e06c75>lgSize</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>lgCacheBlockBytes</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#e06c75>growPermissions</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>grow_param</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>_2</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// state === s_drain_rpq
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_drain_rpq</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req_idx</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>~(</span><span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// é‡æ”¾æ¥å£ 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_drain_rpq</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>deq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>deq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>phys</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Cat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>req_idx</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>deq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>))</span>
</span></span></code></pre></div><p><figure class=gallery-image style=flex-grow:115;flex-basis:276px><a href=/2024/nbdcache/image-20241106195931879.png data-size=680x590><img src=/2024/nbdcache/image-20241106195931879.png width=680 height=590 srcset="/2024/nbdcache/image-20241106195931879_hu6446209596390823114.png 480w, /2024/nbdcache/image-20241106195931879_hu13976723951433692804.png 1024w" loading=lazy></a></figure></p><p><figure class=gallery-image style=flex-grow:291;flex-basis:698px><a href=/2024/nbdcache/image-20241118213723147.png data-size=865x297><img src=/2024/nbdcache/image-20241118213723147.png width=865 height=297 srcset="/2024/nbdcache/image-20241118213723147_hu9817244158531634010.png 480w, /2024/nbdcache/image-20241118213723147_hu7861960807240307719.png 1024w" loading=lazy></a></figure></p><h5 id=rpq>rpq</h5><p>é‡æ”¾é˜Ÿåˆ—</p><ul><li>ç”¨äºæš‚å­˜æœªèƒ½æˆåŠŸå¤„ç†çš„è¯·æ±‚ï¼Œæ¯”å¦‚å› ç¼ºå°‘æƒé™ã€æ•°æ®å°šæœªå‡†å¤‡å¥½ç­‰åŸå› å¯¼è‡´çš„è¯·æ±‚å¤±è´¥ã€‚</li><li>è¿™äº›è¯·æ±‚å°†åœ¨æ¡ä»¶æ»¡è¶³æ—¶é‡æ–°å°è¯•ï¼ˆé‡æ”¾ï¼‰ã€‚</li></ul><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span> <span style=color:#c678dd>val</span> <span style=color:#e06c75>rpq</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Module</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>NBDcacheQueue</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>ReplayInternal</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nRPQ</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// æ— è®ºæ˜¯ä¸€æ¬¡ç¼ºå¤±è¿˜æ˜¯äºŒæ¬¡ç¼ºå¤±ï¼Œæ•°æ®éƒ½ä¼šå­˜æ”¾åœ¨rpqé‡Œ 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>enq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_val</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_rdy</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_sec_val</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>sec_rdy</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>isPrefetch</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>enq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>deq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_drain_rpq</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_invalid</span>
</span></span></code></pre></div><h5 id=addrçš„åˆ’åˆ†>addrçš„åˆ’åˆ†</h5><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>req</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Reg</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>MSHRReqInternal</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>req_idx</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>untagBits</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>req_tag</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>untagBits</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>req_block_addr</span> <span style=color:#c678dd>=</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>blockOffBits</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>idx_match</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>runahead_flag</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>req_block_addr</span> <span style=color:#56b6c2>=/=</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#e5c07b>false</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span><span style=color:#56b6c2>,</span><span style=color:#e06c75>req_idx</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>untagBits</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req_tag</span> 
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx_match</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>=/=</span> <span style=color:#e06c75>s_invalid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>idx_match</span>
</span></span></code></pre></div><p><figure class=gallery-image style=flex-grow:140;flex-basis:336px><a href=/2024/nbdcache/image-20241106201348356.png data-size=584x416><img src=/2024/nbdcache/image-20241106201348356.png width=584 height=416 srcset="/2024/nbdcache/image-20241106201348356_hu16547176067045010742.png 480w, /2024/nbdcache/image-20241106201348356_hu4742350107554157333.png 1024w" loading=lazy></a></figure></p><h5 id=pri_valå’Œpri_rdy--é¦–æ¬¡ç¼ºå¤±>pri_valå’Œpri_rdy é¦–æ¬¡ç¼ºå¤±</h5><p>ä»²è£å™¨çš„é€»è¾‘æ˜¯å¤šä¸ªvalidåŒæ—¶æ‹‰é«˜,å–ä¼˜å…ˆçº§æœ€é«˜çš„,ç„¶åæŠŠç›¸åº”çš„readyæ‹‰é«˜</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_val</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>alloc_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>i</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>ready</span> 
</span></span><span style=display:flex><span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_rdy</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_invalid</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>alloc_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>i</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_rdy</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>alloc_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>sdq_rdy</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>cacheable</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>idx_match</span>
</span></span></code></pre></div><h4 id=å†…å­˜çš„è¾“å‡ºä¸å›å¤ackå’Œacquire>å†…å­˜çš„è¾“å‡ºä¸å›å¤ï¼ˆackå’Œacquire)</h4><p>é€šè¿‡TLAbiter å»é€‰æ‹©ä¼˜å…ˆçº§æœ€ä½çš„ä¸€ä¸ªè¿›è¡Œè¾“å‡º</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#e5c07b>TLArbiter</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>lowestFromSeq</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>edge</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_acquire</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>map</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>_</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_acquire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>++</span> <span style=color:#e06c75>mmios</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>map</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>_</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_access</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#e5c07b>TLArbiter</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>lowestFromSeq</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>edge</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_finish</span><span style=color:#56b6c2>,</span>  <span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>map</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>_</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_finish</span><span style=color:#56b6c2>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>    <span style=color:#7f848e>// å¯ä»¥çœ‹åˆ°ï¼Œä¸»è¦æ˜¯é€šè¿‡idæ¥è¯†åˆ«å›å¤çš„æ•°æ®è¯¥å›å¤ç»™è° 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_ack</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_grant</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_ack</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_grant</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_grant</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>source</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>id</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span>
</span></span></code></pre></div><h2 id=æ•°æ®æµå‘>æ•°æ®æµå‘</h2><h3 id=è¯»>è¯»</h3><p>ä»cpuå‘èµ·æ•°æ®èµ·</p><p>å¯ä»¥çœ‹åˆ°ï¼Œcpuå‘èµ·è¯·æ±‚æ—¶ï¼Œreqå’Œdataæ˜¯å·®äº†ä¸€æ‹çš„ï¼Œåç»­ä¼šæœ‰ä¸€ä¸ªs1æ¥åŒæ­¥data</p><p><figure class=gallery-image style=flex-grow:639;flex-basis:1533px><a href=/2024/nbdcache/image-20241118114559585.png data-size=1355x212><img src=/2024/nbdcache/image-20241118114559585.png width=1355 height=212 srcset="/2024/nbdcache/image-20241118114559585_hu12359997082363122781.png 480w, /2024/nbdcache/image-20241118114559585_hu1847164824895025216.png 1024w" loading=lazy></a></figure></p><p>ç„¶åï¼Œcpu_reqçš„ä¿¡å·ä¼šè¿›å…¥meta_readå’Œdata_readçš„ä»²è£å™¨ï¼Œå°±æ˜¯è¦è¯»tagå’Œdata ,index ä¸º addr [9:6],åŒæ—¶ï¼Œvaddrä¼šè¢«è½¬æ¢ä¸ºpaddr,ç„¶åï¼Œå†ä¸‹ä¸€æ‹s2_req_addrè¢«èµ‹å€¼</p><p>ç¬¬ä¸€æ‹ä»²è£å¹¶è¾“å…¥data,mata,ç¬¬äºŒæ‹è¿”å›æ•°æ®ï¼ˆs1),ç¬¬ä¸‰æ‹é€ç»™mshr(s2),ç¬¬å››æ‹å†™å›mataå’Œdata(s3)ï¼Œ</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#7f848e>// s2åœ¨ç¬¬1çº§æµæ°´çº¿å­˜åœ¨æœ‰æ•ˆæŒ‡ä»¤ (s1_valid)ï¼Œä¸”è¯¥æŒ‡ä»¤æœªè¢«å–æ¶ˆ (~io_cpu_s1_kill)ï¼ŒåŒæ—¶è¯¥æŒ‡ä»¤æ˜¯ä¸€ä¸ª SFENCE æ“ä½œ (s1_sfence) æ—¶ï¼Œå¹¶ä¸”æ²¡æœ‰å‡ºç°ä»»ä½•å¼‚å¸¸çš„æ—¶å€™ï¼Œå°±ä¼šè¢«èµ‹å€¼ä¸º1
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>s2_valid</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>s2_valid_REG</span> <span style=color:#56b6c2>&amp;</span> {<span style=color:#e06c75>_io_cpu_s2_xcpt_ma_ld_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_ma_st_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_pf_ld_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_pf_st_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_gf_ld_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_gf_st_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_ae_ld_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_ae_st_output</span>} <span style=color:#56b6c2>==</span> <span style=color:#d19a66>8&#39;h0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>s1_clk_en</span> <span style=color:#56b6c2>&lt;=</span> <span style=color:#e06c75>_metaReadArb_io_out_valid</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> (<span style=color:#e06c75>s1_clk_en</span>) <span style=color:#c678dd>begin</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>s2_req_addr</span> <span style=color:#56b6c2>&lt;=</span> {<span style=color:#d19a66>8&#39;h0</span>,<span style=color:#e06c75>_dtlb_io_resp_paddr</span>}
</span></span><span style=display:flex><span><span style=color:#c678dd>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#7f848e>//å½“ä»¥ä¸‹æ¡ä»¶åŒæ—¶æ»¡è¶³æ—¶ï¼Œè¯¥è¡¨è¾¾å¼ä¸ºçœŸï¼š
</span></span></span><span style=display:flex><span><span style=color:#7f848e>//s2_valid_maskedï¼šå½“å‰è¯·æ±‚åœ¨ç¬¬2é˜¶æ®µæœ‰æ•ˆä¸”æ²¡æœ‰è¢«å±è”½ã€‚
</span></span></span><span style=display:flex><span><span style=color:#7f848e>//!s2_hitï¼šè¯¥è¯·æ±‚åœ¨ç¼“å­˜ä¸­æœªå‘½ä¸­ã€‚ æ‰€ä»¥è¯´å‘èµ·mshrçš„è¯·æ±‚é¦–å…ˆéœ€è¦æ²¡æœ‰å‘½ä¸­
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>val</span> <span style=color:#e06c75>s2_hit</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>s2_tag_match</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>s2_has_permission</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>s2_hit_state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s2_new_hit_state</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>mshr_valid</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>s2_valid_masked</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>s2_hit</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>isPrefetch</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>s2_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>isRead</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>s2_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>isWrite</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>s2_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#7f848e>// è¿™ä¸ªè¿‡ç¨‹å‘ç”Ÿåœ¨stage 2,å³è¯»å‡ºæ¥æ—¶å°±ä¼šè¿›è¡Œæ£€æŸ¥ï¼Œå‘èµ·è¯»æ˜¯åœ¨stage 1 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>def</span> <span style=color:#e06c75>wayMap</span><span style=color:#56b6c2>[</span><span style=color:#e5c07b>T</span> <span style=color:#c678dd>&lt;:</span> <span style=color:#e5c07b>Data</span><span style=color:#56b6c2>](</span><span style=color:#e06c75>f</span><span style=color:#c678dd>:</span> <span style=color:#e5c07b>Int</span> <span style=color:#56b6c2>=&gt;</span> <span style=color:#e06c75>T</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>VecInit</span><span style=color:#56b6c2>((</span><span style=color:#d19a66>0</span> <span style=color:#e06c75>until</span> <span style=color:#e06c75>nWays</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>map</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>f</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>s1_tag_eq_way</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>wayMap</span><span style=color:#56b6c2>((</span><span style=color:#e06c75>w</span><span style=color:#c678dd>:</span> <span style=color:#e5c07b>Int</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>=&gt;</span> <span style=color:#e06c75>meta</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>resp</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>w</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>tag</span> <span style=color:#56b6c2>===</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>s1_addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>untagBits</span><span style=color:#56b6c2>)).</span><span style=color:#e06c75>asUInt</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>s1_tag_match_way</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>wayMap</span><span style=color:#56b6c2>((</span><span style=color:#e06c75>w</span><span style=color:#c678dd>:</span> <span style=color:#e5c07b>Int</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>=&gt;</span> <span style=color:#e06c75>s1_tag_eq_way</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>w</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>meta</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>resp</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>w</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>coh</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>isValid</span><span style=color:#56b6c2>()).</span><span style=color:#e06c75>asUInt</span>
</span></span></code></pre></div><h2 id=é™„å½•>é™„å½•</h2><h3 id=å‚è€ƒæ–‡çŒ®>å‚è€ƒæ–‡çŒ®</h3><p><a class=link href=https://blog.csdn.net/JACKLJ1998/article/details/124907527 target=_blank rel=noopener>rocket-chipå­¦ä¹ åŸºç¡€ç¯‡</a></p><p><a class=link href=https://docs.xiangshan.cc/zh-cn/latest/memory/dcache/writeback_queue/ target=_blank rel=noopener>é¦™å±±æ‰‹å†Œ</a></p><p><a class=link href=https://jia.je/hardware/2022/05/09/tilelink/ target=_blank rel=noopener>TileLinkä»‹ç»</a></p><h3 id=ç‰ˆæƒä¿¡æ¯>ç‰ˆæƒä¿¡æ¯</h3><p>æœ¬æ–‡åŸè½½äº <a class=link href=https://vastcircle.github.io target=_blank rel=noopener>vastcircle.github.io</a>ï¼Œéµå¾ª CC BY-NC-SA 4.0 åè®®ï¼Œå¤åˆ¶è¯·ä¿ç•™åŸæ–‡å‡ºå¤„ã€‚</p></section><footer class=article-footer><section class=article-tags><a href=/tags/rocket-chip/>Rocket-Chip</a>
<a href=/tags/scala/>Scala</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("//cdn.bootcss.com/pangu/3.3.0/pangu.min.js",function(){pangu.spacingPage()})</script><section class=copyright>&copy;
2023 -
2024 <a href=https://stack-theme-mod.vercel.app/>vastcircle</a>Â·<i class="fas fa-bell"></i> <a id=days>0</a>Days<br>å…±ä¹¦å†™äº†150.3kå­—Â·å…± 41ç¯‡æ–‡ç« </br><span><p></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a><br><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank>Â© Licensed Under CC BY-NC-SA 4.0</a></section><script>var days,number_of_days,s1="2024-10-06",s1=new Date(s1.replace(/-/g,"/"));s2=new Date,days=s2.getTime()-s1.getTime(),number_of_days=parseInt(days/(1e3*60*60*24)),document.getElementById("days").innerHTML=number_of_days</script></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><form action=/search/ class="search-form widget"><p><label>Search</label>
<input name=keyword required placeholder="Type something...">
<button title=Search><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></button></p></form><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#dcacheç»“æ„å›¾>Dcacheç»“æ„å›¾</a></li><li><a href=#æ¦‚è¿°>æ¦‚è¿°</a></li><li><a href=#æ¨¡å—ä»‹ç»>æ¨¡å—ä»‹ç»</a><ol><li><a href=#nonblockingdcachemodule>NonBlockingDCacheModule</a></li><li><a href=#wbu>WBU</a></li><li><a href=#probe>Probe</a></li><li><a href=#l1metadataarray-mata>L1MetadataArray mata</a></li><li><a href=#metareadarb-or-metawritearb>metaReadArb or metaWriteArb</a></li><li><a href=#mshrfile>MSHRFile</a><ol><li><a href=#cacheable>cacheable</a></li><li><a href=#sdq>sdq</a></li><li><a href=#iomshr>iomshr</a></li><li><a href=#mshr>mshr</a></li><li><a href=#å†…å­˜çš„è¾“å‡ºä¸å›å¤ackå’Œacquire>å†…å­˜çš„è¾“å‡ºä¸å›å¤ï¼ˆackå’Œacquire)</a></li></ol></li></ol></li><li><a href=#æ•°æ®æµå‘>æ•°æ®æµå‘</a><ol><li><a href=#è¯»>è¯»</a></li></ol></li><li><a href=#é™„å½•>é™„å½•</a><ol><li><a href=#å‚è€ƒæ–‡çŒ®>å‚è€ƒæ–‡çŒ®</a></li><li><a href=#ç‰ˆæƒä¿¡æ¯>ç‰ˆæƒä¿¡æ¯</a></li></ol></li></ol></nav></div></section><section class="widget categories"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9.828 9.172a4 4 0 100 5.656A10 10 0 0012 12a10 10 0 012.172-2.828 4 4 0 110 5.656A10 10 0 0112 12 10 10 0 009.828 9.172"/></svg></div><h2 class="widget-title section-title">Categories</h2><div class=widget-categories--list><div class=widget><h3 class=widget-title></h3><div class=widget-body><div class=category-list><div class=category-list-item><a href=https://VastCircle.github.io/categories/chipyard/ class=category-list-link>chipyard<span class=category-list-count>3</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/cpu%E5%9F%BA%E7%A1%80/ class=category-list-link>cpuåŸºç¡€<span class=category-list-count>2</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/gem5/ class=category-list-link>gem5<span class=category-list-count>2</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/linux/ class=category-list-link>linux<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/rocket-chip/ class=category-list-link>rocket-chip<span class=category-list-count>2</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/runahead/ class=category-list-link>runahead<span class=category-list-count>3</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/ class=category-list-link>ä»£ç é˜…è¯»<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/ class=category-list-link>åšå®¢æ­å»º<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E5%A4%84%E7%90%86%E5%99%A8/ class=category-list-link>å¤„ç†å™¨<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/ class=category-list-link>ç¯å¢ƒé…ç½®<span class=category-list-count>2</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/ class=category-list-link>ç¼“å­˜ä¸€è‡´æ€§<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/ class=category-list-link>è®ºæ–‡é˜…è¯»<span class=category-list-count>7</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E8%B6%85%E6%A0%87%E9%87%8F%E5%A4%84%E7%90%86%E5%99%A8/ class=category-list-link>è¶…æ ‡é‡å¤„ç†å™¨<span class=category-list-count>12</a></span></div></div></div></div></div></section><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9.828 9.172a4 4 0 100 5.656A10 10 0 0012 12a10 10 0 012.172-2.828 4 4 0 110 5.656A10 10 0 0112 12 10 10 0 009.828 9.172"/></svg></div><h2 class="widget-title section-title">Archives</h2><div class=widget-archive--list><div class=archives-year><a href=/archives/#2024><span class=year>2024</span>
<span class=count>41</span></a></div></div></section><section class="widget tagCloud"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg></div><h2 class="widget-title section-title">Tags</h2><div class=tagCloud-tags><a href=/tags/runahead/ class=font_size_5>Runahead
</a><a href=/tags/vector/ class=font_size_3>Vector
</a><a href=/tags/cache/ class=font_size_2>Cache
</a><a href=/tags/chipyard/ class=font_size_2>Chipyard
</a><a href=/tags/prefetch/ class=font_size_2>Prefetch
</a><a href=/tags/rocket-chip/ class=font_size_2>Rocket-Chip
</a><a href=/tags/%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B/ class=font_size_2>åˆ†æ”¯é¢„æµ‹
</a><a href=/tags/%E5%AF%84%E5%AD%98%E5%99%A8%E9%87%8D%E5%91%BD%E5%90%8D/ class=font_size_2>å¯„å­˜å™¨é‡å‘½å
</a><a href=/tags/%E6%8F%90%E4%BA%A4/ class=font_size_2>æäº¤
</a><a href=/tags/hugo/ class=font_size_1>Hugo</a></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>