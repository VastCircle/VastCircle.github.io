<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content='width=device-width,initial-scale=1'><meta name=description content='Dcache结构图 image-20241111163907552 '><title>NBDcache</title>
<link rel=canonical href=https://VastCircle.github.io/2024/nbdcache/><link rel=stylesheet href=/scss/style.min.46208cabd58e8bcef0cfb7d7ea6b561adcca3b91dd1fc6657493a44f03c5db75.css><meta property='og:title' content='NBDcache'><meta property='og:description' content='Dcache结构图 image-20241111163907552 '><meta property='og:url' content='https://VastCircle.github.io/2024/nbdcache/'><meta property='og:site_name' content="VastCircle's blog"><meta property='og:type' content='article'><meta property='article:section' content='Post'><meta property='article:tag' content='rocket-chip'><meta property='article:tag' content='scala'><meta property='article:published_time' content='2024-11-11T16:33:27+08:00'><meta property='article:modified_time' content='2024-11-11T16:33:27+08:00'><meta name=twitter:title content="NBDcache"><meta name=twitter:description content="Dcache结构图 image-20241111163907552 "><style>:root{--article-font-family:"Noto Serif SC", var(--base-font-family)}</style><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex
<!--
extended
-->
on-phone--column extended"><div id=article-toolbar><a href=https://VastCircle.github.io/ class=back-home><svg class="icon icon-tabler icon-tabler-chevron-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="15 6 9 12 15 18"/></svg>
<span>Back</span></a></div><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header class=site-info><figure class=site-avatar><a href=/><img src=/img/avatar_hu9516569771622178000.png width=300 height=300 class=site-logo loading=lazy alt=Avatar>
</a><span class=emoji>🍥</span></figure><h1 class=site-name><a href=/>VastCircle's blog</a></h1><h2 class=site-description>To shine , not to be illuminated</h2><ol class=social-menu><li><a href=https://github.com/VastCircle target=_blank title=GitHub><svg class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=https://twitter.com target=_blank title=Twitter><svg class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M22 4.01c-1 .49-1.98.689-3 .99-1.121-1.265-2.783-1.335-4.38-.737S11.977 6.323 12 8v1c-3.245.083-6.135-1.395-8-4 0 0-4.182 7.433 4 11-1.872 1.247-3.739 2.088-6 2 3.308 1.803 6.913 2.423 10.034 1.517 3.58-1.04 6.522-3.723 7.651-7.742a13.84 13.84.0 00.497-3.753C20.18 7.773 21.692 5.25 22 4.009z"/></svg></a></li></ol></header><ol class=menu id=main-menu><li><a href=/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>Home</span></a></li><li><a href=/about/><svg class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg>
<span>About</span></a></li><li><a href=/links/><svg class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg>
<span>friends</span></a></li><li><a href=/archives/><svg class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg>
<span>Archives</span></a></li><li><a href=/search/><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg>
<span>Search</span></a></li><li id=dark-mode-toggle><svg class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg>
<span>Dark Mode</span></li></ol></aside><main class="main full-width"><article class=main-article><header class=article-header><div class=article-details><header class=article-category><a href=/categories/%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/>代码阅读</a></header><h2 class=article-title><a href=/2024/nbdcache/>NBDcache</a></h2><footer class=article-time><div><svg class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg>
<time class=article-time--published>Nov 11, 2024</time></div><div><svg class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
<time class=article-words>5173字</time></div></footer></div></header><section class=article-content><h2 id=dcache结构图>Dcache结构图</h2><p><figure class=gallery-image style=flex-grow:141;flex-basis:339px><a href=/2024/nbdcache/image-20241111163907552.png data-size=996x705><img src=/2024/nbdcache/image-20241111163907552.png width=996 height=705 srcset="/2024/nbdcache/image-20241111163907552_hu11066709581250157466.png 480w, /2024/nbdcache/image-20241111163907552_hu15637605824835427283.png 1024w" loading=lazy alt=image-20241111163907552></a><figcaption>image-20241111163907552</figcaption></figure></p><h2 id=概述>概述</h2><p>noblockcache 中共例化了3个小模块,writebackUnit,ProbeUnit,MSHRFile</p><p>该Cache支持主缺失和次缺失两种情况。主缺失是指某个缓存行的首次缺失，导致向主存发送回填请求；而次缺失则是指对缓存的访问也发生缺失，但目标缓存行与之前的主缺失是同一个。</p><p>在MSHR（缺失状态保持寄存器）中，通过主缺失标签和重放队列来跟踪缺失。主缺失标签记录处于处理中的回填请求的地址，并在每次缺失时被搜索，以判断是否为次缺失。发生主缺失时，会分配一个新的主缺失标签来记录地址，发出回填请求，必要时执行驱逐（eviction），并在主缺失标签旁的链表中添加一个新的重放队列条目。重放队列条目包含关于访问的信息，包括对应的缓存行偏移量、字节宽度、用于加载的目标寄存器以及待存储的数据。</p><p>次缺失会在对应的重放队列中添加新的条目，但不会向主存发送额外的回填请求。</p><p>The cache supports both primary misses and secondary misses. A primary miss is the first miss to a cache line and causes a refill request to be sent to main memory, while secondary misses are accesses which miss in the cache but are for the same cache line as an earlier primary miss.</p><p>Misses are tracked in the MSHR using primary miss tags and replay queues. Primary miss tags hold the address of an in-flight refill request and are searched on every miss to determine if it is a secondary miss. A primary miss allocates a new primary miss tag to hold the address, issues a refill request, performs an eviction if needed, and adds a new replay queue entry to a linked list next to the primary miss tag. Replay queue entries contain information about the access including the corresponding cache line offset, the byte width, the destination register for loads, and pending data for stores. A secondary miss adds a new replay queue entry to the appropriate replay queue, but does not send an additional refill request to main memory</p><h2 id=模块介绍>模块介绍</h2><h3 id=nonblockingdcachemodule>NonBlockingDCacheModule</h3><p>目前配置的dcache , 16路</p><p>​ d-cache-block-size = &lt;64>;
​ d-cache-sets = &lt;16>;
​ d-cache-size = &lt;4096></p><p>4路组相联cache 4096/16/64=4</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>s1_req</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Reg</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>HellaCacheReq</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// s1主要是打了一拍,下面其实是在决定把什么数据打一拍，第一拍就是在仲裁什么数据地址该去读data和meta 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// cpu_req : cpu的请求信号
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cpu</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cpu</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 写回module的请求信号
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>wb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Cat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>wb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>wb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>blockOffBits</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>phys</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 控制module的请求信号
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>prober</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Cat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>prober</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>prober</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>blockOffBits</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>phys</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>s2_recycle</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>s1_req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s2_req</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>s1_clk_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#7f848e>//TODO: should be metaReadArb.io.out.fire, but triggers Verilog backend bug
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// metaReadArb按理有5个端口,但是生成的时候端口0貌似被优化了
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s2_recycle</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s2_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>blockOffBits</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>~</span><span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s2_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>2</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>prober</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>3</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>wb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>4</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cpu</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>4</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cpu</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>blockOffBits</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>4</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cpu</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>untagBits</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>metaReadArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>4</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>~</span><span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>)</span>
</span></span></code></pre></div><h3 id=wbu>WBU</h3><p><code>WritebackUnit</code> 模块实现了一个缓存的写回单元，负责通过 TL-C 的 C 通道向 L2 Cache 释放替换块 (Release)。</p><p><code>refillCycles</code> 表示在发生缓存未命中（cache miss）时，从主存或其他缓存中读取数据并将其填充到目标缓存的过程所需的时钟周期数</p><p>需要wbu的module只有 prober 和 mshrs , prober和wbu的数据都是通过c通道进行回复的</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#e06c75>wbArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>prober</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>wbArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>wb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>wbArb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>active</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>r1_data_req_fired</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>false</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>r2_data_req_fired</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>r1_data_req_fired</span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// 返回数据并且返回tag的时候
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>      <span style=color:#7f848e>// 拉高r1_data_req_fired 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>      <span style=color:#e06c75>r1_data_req_fired</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>      <span style=color:#7f848e>// 计数器+1
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>      <span style=color:#e06c75>data_req_cnt</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>data_req_cnt</span> <span style=color:#56b6c2>+</span> <span style=color:#d19a66>1.</span><span style=color:#e06c75>U</span>
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>r2_data_req_fired</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>      <span style=color:#7f848e>// 在返回后的第二拍,拉高release.valid 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>      <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>release</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>when</span><span style=color:#56b6c2>(!</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>release</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>r1_data_req_fired</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>false</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>r2_data_req_fired</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>false</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#7f848e>// 一般都是减去2,除非refilllCycles &lt;= 1
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>        <span style=color:#e06c75>data_req_cnt</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>data_req_cnt</span> <span style=color:#56b6c2>-</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>[</span><span style=color:#e5c07b>UInt</span><span style=color:#56b6c2>]((</span><span style=color:#e06c75>refillCycles</span> <span style=color:#56b6c2>&gt;</span> <span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>B</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>r1_data_req_fired</span><span style=color:#56b6c2>,</span> <span style=color:#d19a66>2.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>,</span> <span style=color:#d19a66>1.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>      <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>when</span><span style=color:#56b6c2>(!</span><span style=color:#e06c75>r1_data_req_fired</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>        <span style=color:#7f848e>// We&#39;re done if this is the final data request and the Release can be sent
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>        <span style=color:#e06c75>active</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>data_req_cnt</span> <span style=color:#56b6c2>&lt;</span> <span style=color:#e06c75>refillCycles</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span> <span style=color:#56b6c2>||</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>release</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span>
</span></span><span style=display:flex><span>      <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span> <span style=color:#7f848e>// 发起请求的时候进行active 和 赋值 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>active</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>data_req_cnt</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>fire</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>(</span><span style=color:#c678dd>if</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>refillCycles</span> <span style=color:#56b6c2>&gt;</span> <span style=color:#d19a66>1</span><span style=color:#56b6c2>)</span> 
</span></span><span style=display:flex><span>                              <span style=color:#e5c07b>Cat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>data_req_cnt</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>log2Up</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>refillCycles</span><span style=color:#56b6c2>)-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>                            <span style=color:#c678dd>else</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>rowOffBits</span>
</span></span></code></pre></div><h3 id=probe>Probe</h3><p>实现了Cache管理模块的状态机，主要用于处理探测请求的操作，管理Cache的状态，判断命中情况，以及处理数据写回操作,主要针对的是tag,不是data</p><p><del>prober的请求输入的数据不是cpu_req,而是auto_out_b_ , 代表这是下一级存储l2，比方说外设发起的读数据，或者在多核心的情况下，core0去读cache0,为了缓存一致性的问题，可能需要sbus去读cache1，然后再去写cache0等</del></p><p>prober应该就是去把dcache的内容给disabled并且写入l2 cache的</p><p>发起auto_out_b_*的是l2 cache</p><p><figure class=gallery-image style=flex-grow:436;flex-basis:1047px><a href=/2024/nbdcache/image-20241120205937336.png data-size=825x189><img src=/2024/nbdcache/image-20241120205937336.png width=825 height=189 srcset="/2024/nbdcache/image-20241120205937336_hu10158162628482713343.png 480w, /2024/nbdcache/image-20241120205937336_hu8485362152773789671.png 1024w" loading=lazy></a></figure></p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#7f848e>// 9个状态
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>val</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>s_invalid</span> <span style=color:#c678dd>:</span><span style=color:#e5c07b>:</span> <span style=color:#e5c07b>s_meta_read</span> <span style=color:#e5c07b>::</span> <span style=color:#e5c07b>s_meta_resp</span> <span style=color:#e5c07b>::</span> <span style=color:#e5c07b>s_mshr_req</span> <span style=color:#e5c07b>::</span>
</span></span><span style=display:flex><span>       <span style=color:#e06c75>s_mshr_resp</span> <span style=color:#c678dd>:</span><span style=color:#e5c07b>:</span> <span style=color:#e5c07b>s_release</span> <span style=color:#e5c07b>::</span> <span style=color:#e5c07b>s_writeback_req</span> <span style=color:#e5c07b>::</span> <span style=color:#e5c07b>s_writeback_resp</span> <span style=color:#e5c07b>::</span> 
</span></span><span style=display:flex><span>       <span style=color:#e06c75>s_meta_write</span> <span style=color:#c678dd>:</span><span style=color:#e5c07b>:</span> <span style=color:#e5c07b>Nil</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Enum</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>9</span><span style=color:#56b6c2>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_resp</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// we need to wait one cycle for the metadata to be read from the array
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_meta_resp</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_mshr_req</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_mshr_req</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>old_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>block_state</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// 比较有意思,如果没有rdy,不是选择wait,而是retry
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>// if the read didn&#39;t go through, we need to retry
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mshr_rdy</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_mshr_resp</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_meta_read</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 如果是脏数据的话，就要写回到l2, 反之需要释放相应的权限（我觉得主要就是权限的改变，但是不需要伴随数据）
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_mshr_resp</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>tag_matches</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>is_dirty</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_writeback_req</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_release</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_release</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>rep</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>tag_matches</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_meta_write</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_invalid</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> <span style=color:#7f848e>// 不管怎么样，最后一步都是write_meta 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span> <span style=color:#7f848e>// wait for the writeback request to finish before updating the metadata
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span> <span style=color:#7f848e>// meta write 应该有将改变的权限写入meta 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_writeback_resp</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_write</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span></code></pre></div><p>逻辑是比较简单的,就是当发起请求时,去meta_read,meta_read之后去读mshr,读出mshr之后,当tag_match的时候且为dirty,需要写回,所以切换到s_writeback_req ,否则到release,release之后去meta_write.写回是由wb模块控制的</p><p>b通道找不到opcode,但和probe相关是肯定的，param代表10,和c一致</p><p>c通道是probe_ack , c_param指示由于探测而在主代理中发生的特定类型的权限更改,</p><p>如下代表probe_ack , BtoN ,降权限的</p><p><figure class=gallery-image style=flex-grow:325;flex-basis:780px><a href=/2024/nbdcache/image-20241122205333780.png data-size=1369x421><img src=/2024/nbdcache/image-20241122205333780.png width=1369 height=421 srcset="/2024/nbdcache/image-20241122205333780_hu6178936314293379860.png 480w, /2024/nbdcache/image-20241122205333780_hu14194576438853189490.png 1024w" loading=lazy></a></figure></p><p>如果是通过wb写回的话，c通道返回就是probe_ackdata ,TtoB,权限降到可读</p><h3 id=l1metadataarray-mata>L1MetadataArray mata</h3><p>meta就是存储tag的地方,是一个同步ram</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#7f848e>// () =&gt; T是函数的写法 ,无输入参数,输出参数是T类型的
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>class</span> <span style=color:#e5c07b>L1MetadataArray</span><span style=color:#56b6c2>[</span><span style=color:#e5c07b>T</span> <span style=color:#c678dd>&lt;:</span> <span style=color:#e5c07b>L1Metadata</span><span style=color:#56b6c2>](</span><span style=color:#e06c75>onReset</span><span style=color:#c678dd>:</span> <span style=color:#56b6c2>()</span> <span style=color:#56b6c2>=&gt;</span> <span style=color:#e06c75>T</span><span style=color:#56b6c2>)(</span><span style=color:#c678dd>implicit</span> <span style=color:#e06c75>p</span><span style=color:#c678dd>:</span> <span style=color:#e5c07b>Parameters</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>extends</span> <span style=color:#e06c75>L1HellaCacheModule</span><span style=color:#56b6c2>()(</span><span style=color:#e06c75>p</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>rstVal</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>onReset</span><span style=color:#56b6c2>()</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>io</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>IO</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>Bundle</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>read</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Flipped</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Decoupled</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e06c75>L1MetaReadReq</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>write</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Flipped</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Decoupled</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e06c75>L1MetaWriteReq</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>resp</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Output</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Vec</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>rstVal</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cloneType</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>rst_cnt</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>RegInit</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>log2Up</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nSets</span><span style=color:#56b6c2>+</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>rst</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>rst_cnt</span> <span style=color:#56b6c2>&lt;</span> <span style=color:#e06c75>nSets</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>waddr</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>rst</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>rst_cnt</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>wdata</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>rst</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>rstVal</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>asUInt</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// way_en是独热码的形式
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>wmask</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>rst</span> <span style=color:#56b6c2>||</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span> <span style=color:#56b6c2>==</span> <span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>B</span><span style=color:#56b6c2>,</span> <span style=color:#56b6c2>(-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>S</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>asSInt</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>asBools</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>rmask</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>rst</span> <span style=color:#56b6c2>||</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span> <span style=color:#56b6c2>==</span> <span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>B</span><span style=color:#56b6c2>,</span> <span style=color:#56b6c2>(-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>S</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>asSInt</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>asBools</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>rst</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#e06c75>rst_cnt</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>rst_cnt</span><span style=color:#56b6c2>+</span><span style=color:#d19a66>1.</span><span style=color:#e06c75>U</span> <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>metabits</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>rstVal</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>getWidth</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// way 是路数 , sets是组数 , way_en 就是用来选择路的
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// 同步mem
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>tag_array</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>SyncReadMem</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nSets</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>Vec</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>UInt</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>metabits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>)))</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>wen</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>rst</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>wen</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>tag_array</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>waddr</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>VecInit</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fill</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>)(</span><span style=color:#e06c75>wdata</span><span style=color:#56b6c2>),</span> <span style=color:#e06c75>wmask</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// read data 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>resp</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>tag_array</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>read</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span><span style=color:#56b6c2>,</span>          <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>()).</span><span style=color:#e06c75>map</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>_</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>asTypeOf</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>chiselTypeOf</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>rstVal</span><span style=color:#56b6c2>)))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>wen</span> <span style=color:#7f848e>// so really this could be a 6T RAM
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>rst</span>
</span></span><span style=display:flex><span><span style=color:#56b6c2>}</span>
</span></span></code></pre></div><h3 id=metareadarb-or-metawritearb>metaReadArb or metaWriteArb</h3><p>metaReadArb仲裁输入为 mshrs , prober , wb ,<strong>mata 和 data都支持多路读取</strong></p><h3 id=mshrfile>MSHRFile</h3><p>缓存控制中的关键部分，用于处理多组MSHR（Miss Status Holding Register），协调多种请求（读、写、填充、写回等）在一级缓存（L1 Cache）中的操作。</p><p>顶层输入的每一个req会发送到每一个mshr中，但是最终只有一个mshr会被选中 ，也就代表只有一个mshr会被写入本笔数据</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_sec_val</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>sdq_rdy</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>tag_match</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>viewAsSupertype</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>HellaCacheReqInternal</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>viewAsSupertype</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>HellaCacheReqInternal</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag_match</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag_match</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>old_meta</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>old_meta</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>sdq_id</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>sdq_alloc_id</span>
</span></span></code></pre></div><h4 id=cacheable>cacheable</h4><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#c678dd>val</span> <span style=color:#e06c75>cacheable</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>edge</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>manager</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>supportsAcquireBFast</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>lgCacheBlockBytes</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>)</span>
</span></span></code></pre></div><p><code>cacheable</code>用于检测当前请求的地址是否可以被缓存。<code>edge.manager.supportsAcquireBFast</code>方法检查缓存控制器是否支持快速获取操作。</p><h4 id=sdq>sdq</h4><p>用于管理store data queue</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span> <span style=color:#7f848e>// 位向量寄存器，用于跟踪SDQ中的空闲条目。每一位代表一个位置，如果为1则表示该位置已被分配，若为0则表示空闲
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>sdq_val</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>RegInit</span><span style=color:#56b6c2>(</span><span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 通过优先编码获取其中一个空闲的sdq的id,从左往右第一个0  
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// 比方说 priorityEncoder(0b0100) = 2 ,priorityEncoder(0b0111) = 2 ,独热转数值 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>sdq_alloc_id</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>PriorityEncoder</span><span style=color:#56b6c2>(~</span><span style=color:#e06c75>sdq_val</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 如果不是全部为1代表有空闲,设为ready 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>sdq_rdy</span> <span style=color:#c678dd>=</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>sdq_val</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>andR</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 表示当前请求是否满足写入SDQ的条件 ,需要请求有效,请求能够被接受,可缓存,并且是写命令 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>sdq_enq</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>cacheable</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>isWrite</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// store data queue ,存放数据 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>sdq</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mem</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>UInt</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>coreDataBits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>))</span> 
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 当满足条件,就写入相应数据 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>sdq_enq</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#e06c75>sdq</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>sdq_alloc_id</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span> <span style=color:#56b6c2>}</span> 
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 用于指示是否可以释放存储数据队列中的一个条目,当io.replay.fire（即重放请求有效且被接受）且当前重放指令是写操作（isWrite(io.replay.bits.cmd)）时，free_sdq为true，表示可以释放该条目。
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>free_sdq</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>isWrite</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>sdq</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>RegEnable</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>replay_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>sdq_id</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>free_sdq</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mask</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span> <span style=color:#56b6c2>&lt;&gt;</span> <span style=color:#e06c75>replay_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// sdq_enq代表要去分配sdq了  io_replay.valid 代表sdq使用完了  
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// uIntToOH(3) = 0b0100 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// priotityEncoderOH把最靠近左边的1 set  , 比方说 sdq_val = 0b0011, 则 priorityEncoderOH(~sdq_val(cfg.SDQ-1,0)) = 0b0010 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>sdq_enq</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>sdq_val</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>sdq_val</span> <span style=color:#56b6c2>&amp;</span> <span style=color:#56b6c2>~(</span><span style=color:#e5c07b>UIntToOH</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>replay_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>sdq_id</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&amp;</span> <span style=color:#e5c07b>Fill</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>free_sdq</span><span style=color:#56b6c2>))</span> <span style=color:#7f848e>// reset 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>                       <span style=color:#56b6c2>|</span> <span style=color:#e5c07b>PriorityEncoderOH</span><span style=color:#56b6c2>(~</span><span style=color:#e06c75>sdq_val</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>))</span> <span style=color:#56b6c2>&amp;</span> <span style=color:#e5c07b>Fill</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nSDQ</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>sdq_enq</span><span style=color:#56b6c2>)</span>  <span style=color:#7f848e>// set
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>replay_arb</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Module</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>Arbiter</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>ReplayInternal</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nMSHRs</span><span style=color:#56b6c2>))</span>
</span></span></code></pre></div><h4 id=iomshr>iomshr</h4><p>输入是s2_req ， 回应resp，这里的resp是直接接入到MSHRfile顶层端口的，它和mshr是同一类东西，应该就是mmio,就是不经过cache的数据,但是本身mshr保存的是缓存未命中的请求以及相关状态，层次有点问题吧</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#e06c75>mmio_alloc_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>cacheable</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span> <span style=color:#c678dd>val</span> <span style=color:#e06c75>io</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>IO</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>Bundle</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>req</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Flipped</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Decoupled</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>HellaCacheReq</span><span style=color:#56b6c2>))</span>          <span style=color:#7f848e>// MSHRfile发起的req 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>resp</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Decoupled</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>HellaCacheResp</span><span style=color:#56b6c2>)</span>                 <span style=color:#7f848e>// resp 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>mem_access</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Decoupled</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>TLBundleA</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>edge</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bundle</span><span style=color:#56b6c2>))</span>   <span style=color:#7f848e>// 向mem发起的请求
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>mem_ack</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Flipped</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Valid</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>TLBundleD</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>edge</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bundle</span><span style=color:#56b6c2>)))</span> <span style=color:#7f848e>// mem ack 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>replay_next</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Output</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Bool</span><span style=color:#56b6c2>())</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>})</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#7f848e>// 输入握手的时候，获取数据 req  stage 3 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_mem_access</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span> <span style=color:#7f848e>// 获取内存数据
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_access</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_mem_ack</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 内存数据响应
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_mem_ack</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_ack</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_resp</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>isRead</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>))</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>      <span style=color:#7f848e>// 获取响应的数据
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>      <span style=color:#e06c75>grant_word</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>wordFromBeat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_ack</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 发出去了
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>resp</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_idle</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span></code></pre></div><p><figure class=gallery-image style=flex-grow:212;flex-basis:508px><a href=/2024/nbdcache/image-20241118210021805.png data-size=844x398><img src=/2024/nbdcache/image-20241118210021805.png width=844 height=398 srcset="/2024/nbdcache/image-20241118210021805_hu12660496501136547085.png 480w, /2024/nbdcache/image-20241118210021805_hu18334060945906226560.png 1024w" loading=lazy></a></figure></p><p>其实这个仲裁器像是倒着用的，是把io.req信号去选择一个mshr去输出</p><h4 id=mshr>mshr</h4><p>输入是s2_req</p><p>每个MSHR处理一个缓存块的缺失请求</p><p>mshr应该就是其中的一个表项,这里通过状态机来判断表项是一次缺失还是二次缺失 ,是不是太奢侈了</p><p>该模块的主要功能是管理和协调多种缓存操作，</p><ol><li>处理缓存未命中时的请求。</li><li>向主存发出请求并等待响应。</li><li>维护状态机以跟踪请求的进度。</li><li>根据不同情况执行不同的控制流。</li></ol><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>idxMatch</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Wire</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Vec</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nMSHRs</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>Bool</span><span style=color:#56b6c2>()))</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>tagList</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Wire</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>Vec</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nMSHRs</span><span style=color:#56b6c2>,</span> <span style=color:#e5c07b>Bits</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>tagBits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>)))</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// idxMatch 只有一个会拉高
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>tag_match</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux1H</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>idxMatch</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>tagList</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>untagBits</span>
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><h5 id=状态转移及相应输出>状态转移及相应输出</h5><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#7f848e>// state 是一个寄存器，用于跟踪 MSHR 的状态。状态机的主要状态包括：
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_invalid：空闲状态，表示 MSHR 未被占用。
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_wb_req 和 s_wb_resp：处理写回操作的状态。
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_meta_clear：清理缓存元数据。
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_refill_req 和 s_refill_resp：处理从主存中获取数据的请求。
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_meta_write_req 和 s_meta_write_resp：更新缓存元数据。
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#7f848e>// s_drain_rpq：处理重放队列的请求
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span> <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_drain_rpq</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>deq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_invalid</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_meta_write_resp</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// this wait state allows us to catch RAW hazards on the tags via nack_victim
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_drain_rpq</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_meta_write_req</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_write_resp</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_refill_resp</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>refill_done</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>new_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>coh_on_grant</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_write_req</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_acquire</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#7f848e>// s_refill_req
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_refill_resp</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_meta_clear</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_refill_req</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_wb_resp</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>acked</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_clear</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>fire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#7f848e>// s_wb_req
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_wb_resp</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_sec_val</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_sec_rdy</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#7f848e>// s_wb_req, s_wb_resp, s_refill_req
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//If we get a secondary miss that needs more permissions before we&#39;ve sent
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//  out the primary miss&#39;s Acquire, we can upgrade the permissions we&#39;re 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//  going to ask for in s_refill_req
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>dirtier_cmd</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>is_hit_again</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>new_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>dirtier_coh</span>
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span> 
</span></span><span style=display:flex><span><span style=color:#7f848e>// 首次miss的时候,赋值req, 这说明req是被保存在mshr上的,只有首次缺失才会改变
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_val</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_rdy</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>req</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>acked</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>false</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>old_coh</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>old_meta</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>coh</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#e06c75>needs_wb</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>old_coh</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>onCacheControl</span><span style=color:#56b6c2>(</span><span style=color:#e5c07b>M_FLUSH</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>_1</span>
</span></span><span style=display:flex><span>    <span style=color:#c678dd>val</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>is_hit</span><span style=color:#56b6c2>,</span> <span style=color:#c678dd>_</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>coh_on_hit</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>old_coh</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>onAccess</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>    <span style=color:#7f848e>// 如果命中：
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//更新一致性状态：将new_coh设为coh_on_hit。
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//设置状态为MetaWrite：准备写回元数据。
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//如果未命中但标记匹配：
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//保持一致性状态不变。
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#7f848e>//状态转为Refill：准备请求新的数据。
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag_match</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>when</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>is_hit</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>{</span> <span style=color:#7f848e>// set dirty bit
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>        <span style=color:#e06c75>new_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>coh_on_hit</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_meta_write_req</span>
</span></span><span style=display:flex><span>      <span style=color:#56b6c2>}.</span><span style=color:#e06c75>otherwise</span> <span style=color:#56b6c2>{</span> <span style=color:#7f848e>// upgrade permissions
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>        <span style=color:#e06c75>new_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>old_coh</span>
</span></span><span style=display:flex><span>        <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>s_refill_req</span>
</span></span><span style=display:flex><span>      <span style=color:#56b6c2>}</span> 
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}.</span><span style=color:#e06c75>otherwise</span> <span style=color:#56b6c2>{</span>
</span></span><span style=display:flex><span>        <span style=color:#7f848e>// writback if necessary and refill 标记不匹配：判断是否需要写回旧数据，并准备加载新数据。
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>      <span style=color:#e06c75>new_coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>ClientMetadata</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>onReset</span>
</span></span><span style=display:flex><span>      <span style=color:#e06c75>state</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>needs_wb</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_wb_req</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_meta_clear</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>    <span style=color:#56b6c2>}</span>
</span></span><span style=display:flex><span>  <span style=color:#56b6c2>}</span> 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// state === s_meta_write_req or s_mata_clear 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>isOneOf</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>s_meta_write_req</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>s_meta_clear</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req_idx</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>coh</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_meta_clear</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>coh_on_clear</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>new_coh</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>data</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_write</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// state === s_wb_req 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_wb_req</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>source</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>id</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>old_meta</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req_idx</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>param</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>shrink_param</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>wb_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>voluntary</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// state === s_refill_req 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_acquire</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_refill_req</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>grantackq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>enq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_acquire</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>edge</span><span style=color:#56b6c2>.</span><span style=color:#e5c07b>AcquireBlock</span><span style=color:#56b6c2>(</span>
</span></span><span style=display:flex><span>                                <span style=color:#e06c75>fromSource</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>id</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#e06c75>toAddress</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Cat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>req_idx</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#e06c75>lgSize</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>lgCacheBlockBytes</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>,</span>
</span></span><span style=display:flex><span>                                <span style=color:#e06c75>growPermissions</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>grow_param</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>_2</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// state === s_drain_rpq
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_drain_rpq</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req_idx</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>meta_read</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>way_en</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>~(</span><span style=color:#d19a66>0.</span><span style=color:#e06c75>U</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>nWays</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>W</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 重放接口 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_drain_rpq</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>deq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>deq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>phys</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>true</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e5c07b>Cat</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>req_idx</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>deq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#d19a66>0</span><span style=color:#56b6c2>))</span>
</span></span></code></pre></div><p><figure class=gallery-image style=flex-grow:115;flex-basis:276px><a href=/2024/nbdcache/image-20241106195931879.png data-size=680x590><img src=/2024/nbdcache/image-20241106195931879.png width=680 height=590 srcset="/2024/nbdcache/image-20241106195931879_hu6446209596390823114.png 480w, /2024/nbdcache/image-20241106195931879_hu13976723951433692804.png 1024w" loading=lazy></a></figure></p><p><figure class=gallery-image style=flex-grow:291;flex-basis:698px><a href=/2024/nbdcache/image-20241118213723147.png data-size=865x297><img src=/2024/nbdcache/image-20241118213723147.png width=865 height=297 srcset="/2024/nbdcache/image-20241118213723147_hu9817244158531634010.png 480w, /2024/nbdcache/image-20241118213723147_hu7861960807240307719.png 1024w" loading=lazy></a></figure></p><h5 id=rpq>rpq</h5><p>重放队列</p><ul><li>用于暂存未能成功处理的请求，比如因缺少权限、数据尚未准备好等原因导致的请求失败。</li><li>这些请求将在条件满足时重新尝试（重放）。</li></ul><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span> <span style=color:#c678dd>val</span> <span style=color:#e06c75>rpq</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Module</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>NBDcacheQueue</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>ReplayInternal</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>cfg</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>nRPQ</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#7f848e>// 无论是一次缺失还是二次缺失，数据都会存放在rpq里 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>  <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>enq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_val</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_rdy</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_sec_val</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>sec_rdy</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>isPrefetch</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>enq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>rpq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>deq</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>replay</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_drain_rpq</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_invalid</span>
</span></span></code></pre></div><h5 id=addr的划分>addr的划分</h5><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>req</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Reg</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>new</span> <span style=color:#e5c07b>MSHRReqInternal</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>req_idx</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>untagBits</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>)</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>req_tag</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>untagBits</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>req_block_addr</span> <span style=color:#c678dd>=</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>blockOffBits</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>idx_match</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>Mux</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>runahead_flag</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>req_block_addr</span> <span style=color:#56b6c2>=/=</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&lt;&lt;</span> <span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>,</span>
</span></span><span style=display:flex><span>                      <span style=color:#e5c07b>false</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>B</span><span style=color:#56b6c2>,</span><span style=color:#e06c75>req_idx</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>addr</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>untagBits</span><span style=color:#56b6c2>-</span><span style=color:#d19a66>1</span><span style=color:#56b6c2>,</span><span style=color:#e06c75>blockOffBits</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>tag</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>req_tag</span> 
</span></span><span style=display:flex><span>  <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>idx_match</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>state</span> <span style=color:#56b6c2>=/=</span> <span style=color:#e06c75>s_invalid</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>idx_match</span>
</span></span></code></pre></div><p><figure class=gallery-image style=flex-grow:140;flex-basis:336px><a href=/2024/nbdcache/image-20241106201348356.png data-size=584x416><img src=/2024/nbdcache/image-20241106201348356.png width=584 height=416 srcset="/2024/nbdcache/image-20241106201348356_hu16547176067045010742.png 480w, /2024/nbdcache/image-20241106201348356_hu4742350107554157333.png 1024w" loading=lazy></a></figure></p><h5 id=pri_val和pri_rdy--首次缺失>pri_val和pri_rdy 首次缺失</h5><p>仲裁器的逻辑是多个valid同时拉高,取优先级最高的,然后把相应的ready拉高</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_val</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>alloc_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>i</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>ready</span> 
</span></span><span style=display:flex><span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_rdy</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s_invalid</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>alloc_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>in</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>i</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req_pri_rdy</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>alloc_arb</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>out</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>ready</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>sdq_rdy</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>cacheable</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>idx_match</span>
</span></span></code></pre></div><h4 id=内存的输出与回复ack和acquire>内存的输出与回复（ack和acquire)</h4><p>通过TLAbiter 去选择优先级最低的一个进行输出</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>  <span style=color:#e5c07b>TLArbiter</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>lowestFromSeq</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>edge</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_acquire</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>map</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>_</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_acquire</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>++</span> <span style=color:#e06c75>mmios</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>map</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>_</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_access</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#e5c07b>TLArbiter</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>lowestFromSeq</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>edge</span><span style=color:#56b6c2>,</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_finish</span><span style=color:#56b6c2>,</span>  <span style=color:#e06c75>mshrs</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>map</span><span style=color:#56b6c2>(</span><span style=color:#c678dd>_</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_finish</span><span style=color:#56b6c2>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>    <span style=color:#7f848e>// 可以看到，主要是通过id来识别回复的数据该回复给谁 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_ack</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_grant</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span>
</span></span><span style=display:flex><span>    <span style=color:#e06c75>mshr</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_ack</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#c678dd>:</span><span style=color:#56b6c2>=</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_grant</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>valid</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>mem_grant</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>bits</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>source</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>id</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>U</span>
</span></span></code></pre></div><h2 id=数据流向>数据流向</h2><h3 id=读>读</h3><p>从cpu发起数据起</p><p>可以看到，cpu发起请求时，req和data是差了一拍的，后续会有一个s1来同步data</p><p><figure class=gallery-image style=flex-grow:639;flex-basis:1533px><a href=/2024/nbdcache/image-20241118114559585.png data-size=1355x212><img src=/2024/nbdcache/image-20241118114559585.png width=1355 height=212 srcset="/2024/nbdcache/image-20241118114559585_hu12359997082363122781.png 480w, /2024/nbdcache/image-20241118114559585_hu1847164824895025216.png 1024w" loading=lazy></a></figure></p><p>然后，cpu_req的信号会进入meta_read和data_read的仲裁器，就是要读tag和data ,index 为 addr [9:6],同时，vaddr会被转换为paddr,然后，再下一拍s2_req_addr被赋值</p><p>第一拍仲裁并输入data,mata,第二拍返回数据（s1),第三拍送给mshr(s2),第四拍写回mata和data(s3)，</p><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-verilog data-lang=verilog><span style=display:flex><span><span style=color:#7f848e>// s2在第1级流水线存在有效指令 (s1_valid)，且该指令未被取消 (~io_cpu_s1_kill)，同时该指令是一个 SFENCE 操作 (s1_sfence) 时，并且没有出现任何异常的时候，就会被赋值为1
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#e06c75>s2_valid</span> <span style=color:#56b6c2>=</span> <span style=color:#e06c75>s2_valid_REG</span> <span style=color:#56b6c2>&amp;</span> {<span style=color:#e06c75>_io_cpu_s2_xcpt_ma_ld_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_ma_st_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_pf_ld_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_pf_st_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_gf_ld_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_gf_st_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_ae_ld_output</span>, <span style=color:#e06c75>_io_cpu_s2_xcpt_ae_st_output</span>} <span style=color:#56b6c2>==</span> <span style=color:#d19a66>8&#39;h0</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#e06c75>s1_clk_en</span> <span style=color:#56b6c2>&lt;=</span> <span style=color:#e06c75>_metaReadArb_io_out_valid</span>
</span></span><span style=display:flex><span><span style=color:#c678dd>if</span> (<span style=color:#e06c75>s1_clk_en</span>) <span style=color:#c678dd>begin</span>
</span></span><span style=display:flex><span>	<span style=color:#e06c75>s2_req_addr</span> <span style=color:#56b6c2>&lt;=</span> {<span style=color:#d19a66>8&#39;h0</span>,<span style=color:#e06c75>_dtlb_io_resp_paddr</span>}
</span></span><span style=display:flex><span><span style=color:#c678dd>end</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#7f848e>//当以下条件同时满足时，该表达式为真：
</span></span></span><span style=display:flex><span><span style=color:#7f848e>//s2_valid_masked：当前请求在第2阶段有效且没有被屏蔽。
</span></span></span><span style=display:flex><span><span style=color:#7f848e>//!s2_hit：该请求在缓存中未命中。 所以说发起mshr的请求首先需要没有命中
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>val</span> <span style=color:#e06c75>s2_hit</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>s2_tag_match</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>s2_has_permission</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>s2_hit_state</span> <span style=color:#56b6c2>===</span> <span style=color:#e06c75>s2_new_hit_state</span>
</span></span><span style=display:flex><span><span style=color:#e06c75>mshr_valid</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>s2_valid_masked</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>!</span><span style=color:#e06c75>s2_hit</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>isPrefetch</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>s2_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>isRead</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>s2_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>||</span> <span style=color:#e06c75>isWrite</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>s2_req</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>cmd</span><span style=color:#56b6c2>))</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#abb2bf;background-color:#282c34;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#7f848e>// 这个过程发生在stage 2,即读出来时就会进行检查，发起读是在stage 1 
</span></span></span><span style=display:flex><span><span style=color:#7f848e></span><span style=color:#c678dd>def</span> <span style=color:#e06c75>wayMap</span><span style=color:#56b6c2>[</span><span style=color:#e5c07b>T</span> <span style=color:#c678dd>&lt;:</span> <span style=color:#e5c07b>Data</span><span style=color:#56b6c2>](</span><span style=color:#e06c75>f</span><span style=color:#c678dd>:</span> <span style=color:#e5c07b>Int</span> <span style=color:#56b6c2>=&gt;</span> <span style=color:#e06c75>T</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>=</span> <span style=color:#e5c07b>VecInit</span><span style=color:#56b6c2>((</span><span style=color:#d19a66>0</span> <span style=color:#e06c75>until</span> <span style=color:#e06c75>nWays</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>map</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>f</span><span style=color:#56b6c2>))</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>s1_tag_eq_way</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>wayMap</span><span style=color:#56b6c2>((</span><span style=color:#e06c75>w</span><span style=color:#c678dd>:</span> <span style=color:#e5c07b>Int</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>=&gt;</span> <span style=color:#e06c75>meta</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>resp</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>w</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>tag</span> <span style=color:#56b6c2>===</span> <span style=color:#56b6c2>(</span><span style=color:#e06c75>s1_addr</span> <span style=color:#56b6c2>&gt;&gt;</span> <span style=color:#e06c75>untagBits</span><span style=color:#56b6c2>)).</span><span style=color:#e06c75>asUInt</span>
</span></span><span style=display:flex><span>  <span style=color:#c678dd>val</span> <span style=color:#e06c75>s1_tag_match_way</span> <span style=color:#c678dd>=</span> <span style=color:#e06c75>wayMap</span><span style=color:#56b6c2>((</span><span style=color:#e06c75>w</span><span style=color:#c678dd>:</span> <span style=color:#e5c07b>Int</span><span style=color:#56b6c2>)</span> <span style=color:#c678dd>=&gt;</span> <span style=color:#e06c75>s1_tag_eq_way</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>w</span><span style=color:#56b6c2>)</span> <span style=color:#56b6c2>&amp;&amp;</span> <span style=color:#e06c75>meta</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>io</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>resp</span><span style=color:#56b6c2>(</span><span style=color:#e06c75>w</span><span style=color:#56b6c2>).</span><span style=color:#e06c75>coh</span><span style=color:#56b6c2>.</span><span style=color:#e06c75>isValid</span><span style=color:#56b6c2>()).</span><span style=color:#e06c75>asUInt</span>
</span></span></code></pre></div><h2 id=附录>附录</h2><h3 id=参考文献>参考文献</h3><p><a class=link href=https://blog.csdn.net/JACKLJ1998/article/details/124907527 target=_blank rel=noopener>rocket-chip学习基础篇</a></p><p><a class=link href=https://docs.xiangshan.cc/zh-cn/latest/memory/dcache/writeback_queue/ target=_blank rel=noopener>香山手册</a></p><p><a class=link href=https://jia.je/hardware/2022/05/09/tilelink/ target=_blank rel=noopener>TileLink介绍</a></p><h3 id=版权信息>版权信息</h3><p>本文原载于 <a class=link href=https://vastcircle.github.io target=_blank rel=noopener>vastcircle.github.io</a>，遵循 CC BY-NC-SA 4.0 协议，复制请保留原文出处。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/rocket-chip/>Rocket-Chip</a>
<a href=/tags/scala/>Scala</a></section><section class=article-copyright><svg class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg>
<span>Licensed under CC BY-NC-SA 4.0</span></section></footer></article><aside class=related-contents--wrapper></aside><div class=disqus-container><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//stack.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><script>(function(e,t){var s=document,o="script",n=s.createElement(o),i=s.getElementsByTagName(o)[0];n.src=e,t&&n.addEventListener("load",function(e){t(e)}),i.parentNode.insertBefore(n,i)})("//cdn.bootcss.com/pangu/3.3.0/pangu.min.js",function(){pangu.spacingPage()})</script><section class=copyright>&copy;
2023 -
2024 <a href=https://stack-theme-mod.vercel.app/>vastcircle</a>·<i class="fas fa-bell"></i> <a id=days>0</a>Days<br>共书写了150.3k字·共 41篇文章</br><span><p></section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.2.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a><br><a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank>© Licensed Under CC BY-NC-SA 4.0</a></section><script>var days,number_of_days,s1="2024-10-06",s1=new Date(s1.replace(/-/g,"/"));s2=new Date,days=s2.getTime()-s1.getTime(),number_of_days=parseInt(days/(1e3*60*60*24)),document.getElementById("days").innerHTML=number_of_days</script></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><form action=/search/ class="search-form widget"><p><label>Search</label>
<input name=keyword required placeholder="Type something...">
<button title=Search><svg class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></button></p></form><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#dcache结构图>Dcache结构图</a></li><li><a href=#概述>概述</a></li><li><a href=#模块介绍>模块介绍</a><ol><li><a href=#nonblockingdcachemodule>NonBlockingDCacheModule</a></li><li><a href=#wbu>WBU</a></li><li><a href=#probe>Probe</a></li><li><a href=#l1metadataarray-mata>L1MetadataArray mata</a></li><li><a href=#metareadarb-or-metawritearb>metaReadArb or metaWriteArb</a></li><li><a href=#mshrfile>MSHRFile</a><ol><li><a href=#cacheable>cacheable</a></li><li><a href=#sdq>sdq</a></li><li><a href=#iomshr>iomshr</a></li><li><a href=#mshr>mshr</a></li><li><a href=#内存的输出与回复ack和acquire>内存的输出与回复（ack和acquire)</a></li></ol></li></ol></li><li><a href=#数据流向>数据流向</a><ol><li><a href=#读>读</a></li></ol></li><li><a href=#附录>附录</a><ol><li><a href=#参考文献>参考文献</a></li><li><a href=#版权信息>版权信息</a></li></ol></li></ol></nav></div></section><section class="widget categories"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9.828 9.172a4 4 0 100 5.656A10 10 0 0012 12a10 10 0 012.172-2.828 4 4 0 110 5.656A10 10 0 0112 12 10 10 0 009.828 9.172"/></svg></div><h2 class="widget-title section-title">Categories</h2><div class=widget-categories--list><div class=widget><h3 class=widget-title></h3><div class=widget-body><div class=category-list><div class=category-list-item><a href=https://VastCircle.github.io/categories/chipyard/ class=category-list-link>chipyard<span class=category-list-count>3</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/cpu%E5%9F%BA%E7%A1%80/ class=category-list-link>cpu基础<span class=category-list-count>2</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/gem5/ class=category-list-link>gem5<span class=category-list-count>2</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/linux/ class=category-list-link>linux<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/rocket-chip/ class=category-list-link>rocket-chip<span class=category-list-count>2</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/runahead/ class=category-list-link>runahead<span class=category-list-count>3</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E4%BB%A3%E7%A0%81%E9%98%85%E8%AF%BB/ class=category-list-link>代码阅读<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E5%8D%9A%E5%AE%A2%E6%90%AD%E5%BB%BA/ class=category-list-link>博客搭建<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E5%A4%84%E7%90%86%E5%99%A8/ class=category-list-link>处理器<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE/ class=category-list-link>环境配置<span class=category-list-count>2</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E7%BC%93%E5%AD%98%E4%B8%80%E8%87%B4%E6%80%A7/ class=category-list-link>缓存一致性<span class=category-list-count>1</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/ class=category-list-link>论文阅读<span class=category-list-count>7</a></span></div><div class=category-list-item><a href=https://VastCircle.github.io/categories/%E8%B6%85%E6%A0%87%E9%87%8F%E5%A4%84%E7%90%86%E5%99%A8/ class=category-list-link>超标量处理器<span class=category-list-count>12</a></span></div></div></div></div></div></section><section class="widget archives"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-infinity" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M9.828 9.172a4 4 0 100 5.656A10 10 0 0012 12a10 10 0 012.172-2.828 4 4 0 110 5.656A10 10 0 0112 12 10 10 0 009.828 9.172"/></svg></div><h2 class="widget-title section-title">Archives</h2><div class=widget-archive--list><div class=archives-year><a href=/archives/#2024><span class=year>2024</span>
<span class=count>41</span></a></div></div></section><section class="widget tagCloud"><div class=widget-icon><svg class="icon icon-tabler icon-tabler-tag" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11 3l9 9a1.5 1.5.0 010 2l-6 6a1.5 1.5.0 01-2 0L3 11V7a4 4 0 014-4h4"/><circle cx="9" cy="9" r="2"/></svg></div><h2 class="widget-title section-title">Tags</h2><div class=tagCloud-tags><a href=/tags/runahead/ class=font_size_5>Runahead
</a><a href=/tags/vector/ class=font_size_3>Vector
</a><a href=/tags/cache/ class=font_size_2>Cache
</a><a href=/tags/chipyard/ class=font_size_2>Chipyard
</a><a href=/tags/prefetch/ class=font_size_2>Prefetch
</a><a href=/tags/rocket-chip/ class=font_size_2>Rocket-Chip
</a><a href=/tags/%E5%88%86%E6%94%AF%E9%A2%84%E6%B5%8B/ class=font_size_2>分支预测
</a><a href=/tags/%E5%AF%84%E5%AD%98%E5%99%A8%E9%87%8D%E5%91%BD%E5%90%8D/ class=font_size_2>寄存器重命名
</a><a href=/tags/%E6%8F%90%E4%BA%A4/ class=font_size_2>提交
</a><a href=/tags/hugo/ class=font_size_1>Hugo</a></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script><script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>